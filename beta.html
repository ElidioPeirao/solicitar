<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitação de Material ao Almoxarifado</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-section, .tabs-container { display: none; }
        .form-section.active, .tabs-container.active { display: block; }
        .matricula-feedback { transition: opacity 0.3s; }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
        .modal-enter { animation: fadeIn 0.3s ease-out forwards; }
        .modal-leave { animation: fadeOut 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
        details > summary .chevron { transition: transform 0.2s; }
        details[open] > summary .chevron { transform: rotate(90deg); }
        
        /* Estilo para o Monitor */
        #firebase-monitor {
            font-family: 'Courier New', Courier, monospace;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        
        /* Estilo para tags de data */
        .date-tag {
            animation: fadeIn 0.2s ease-out;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4 pb-20">

    <div class="container mx-auto max-w-4xl w-full">
        <!-- Main Container -->
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-lg">
            <h1 class="text-2xl md:text-3xl font-bold mb-6 text-gray-700 text-center">
                <i class="fas fa-paper-plane text-blue-500 mr-3"></i>Portal de Solicitação
            </h1>

            <!-- User Identification Section -->
            <div id="identification-section">
                <label for="solicitante-matricula" class="block text-sm font-medium text-gray-700 mb-1">Digite sua Matrícula para Começar</label>
                <div class="flex items-center gap-2">
                    <div class="relative flex-grow">
                        <input type="text" id="solicitante-matricula" class="w-full p-3 border border-gray-300 rounded-md shadow-sm" placeholder="Sua matrícula aqui..." required>
                        <span id="matricula-feedback-icon" class="matricula-feedback absolute right-3 top-1/2 -translate-y-1/2 text-lg opacity-0"></span>
                    </div>
                    <button type="button" id="acessar-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg">Acessar</button>
                    <button type="button" id="trocar-usuario-btn" class="hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-5 rounded-lg">Trocar</button>
                </div>
                <div id="professor-info" class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-md hidden">
                    <span class="font-medium text-blue-800">Colaborador:</span>
                    <span id="professor-name-display" class="font-bold text-blue-900"></span>
                </div>
                <p id="matricula-error" class="text-red-600 text-sm font-semibold mt-1 hidden">Matrícula não encontrada.</p>
            </div>

            <!-- Tabs Navigation -->
            <div class="tabs-container mt-8">
                <div class="border-b border-gray-200">
                    <nav class="flex -mb-px" aria-label="Tabs">
                        <button data-tab="solicitacao" class="tab-button active w-1/4 text-center py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600">
                           <i class="fas fa-edit mr-2"></i>Fazer Solicitação
                        </button>
                        <button data-tab="kits" class="tab-button w-1/4 text-center py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600">
                           <i class="fas fa-box-archive mr-2"></i>Meus Kits
                        </button>
                        <button data-tab="historico" class="tab-button w-1/4 text-center py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600">
                           <i class="fas fa-history mr-2"></i>Histórico
                        </button>
                        <button data-tab="compra" class="tab-button w-1/4 text-center py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600">
                           <i class="fas fa-shopping-cart mr-2"></i>Solicitar Compra
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Tab Content: Solicitação -->
            <div id="tab-content-solicitacao" class="form-section">
                <form id="form-solicitacao" class="mt-6" novalidate>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                         <div class="flex flex-col">
                            <label for="data-agendamento" class="block text-sm font-medium text-gray-700 mb-1">Data da Retirada</label>
                            <div class="flex gap-2">
                                <input type="date" id="data-agendamento" class="w-full p-3 border border-gray-300 rounded-md shadow-sm" required>
                                <button type="button" id="add-date-btn" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 rounded-md font-bold transition-colors" title="Adicionar Data com os Períodos Selecionados">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <!-- Container para datas selecionadas -->
                            <div id="selected-dates-container" class="flex flex-wrap gap-2 mt-2 min-h-[1.5rem]"></div>
                        </div>
                        
                        <!-- Coluna Períodos (Dropdown Customizado) -->
                        <div class="relative">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Períodos de Uso</label>
                            <button type="button" id="periodo-dropdown-btn" class="w-full p-3 border border-gray-300 rounded-md shadow-sm bg-white text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <span id="periodo-selected-text" class="truncate text-gray-700">Manhã</span>
                                <i class="fas fa-chevron-down text-gray-400 text-sm ml-2"></i>
                            </button>
                            
                            <!-- Dropdown Content (Oculto inicialmente) -->
                            <div id="periodo-dropdown-content" class="hidden absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-xl py-1">
                                <div id="periodos-container" class="flex flex-col">
                                    <label class="flex items-center px-4 py-2 hover:bg-gray-50 cursor-pointer">
                                        <input type="checkbox" name="periodo" value="Manhã" class="form-checkbox h-4 w-4 text-blue-600 rounded focus:ring-blue-500" checked>
                                        <span class="ml-3 text-sm text-gray-700">Manhã</span>
                                    </label>
                                    <label class="flex items-center px-4 py-2 hover:bg-gray-50 cursor-pointer">
                                        <input type="checkbox" name="periodo" value="Tarde" class="form-checkbox h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                                        <span class="ml-3 text-sm text-gray-700">Tarde</span>
                                    </label>
                                    <label class="flex items-center px-4 py-2 hover:bg-gray-50 cursor-pointer">
                                        <input type="checkbox" name="periodo" value="Noite" class="form-checkbox h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                                        <span class="ml-3 text-sm text-gray-700">Noite</span>
                                    </label>
                                    <div class="border-t border-gray-100 my-1"></div>
                                    <label class="flex items-center px-4 py-2 hover:bg-blue-50 cursor-pointer">
                                        <input type="checkbox" name="periodo" value="Integral" class="form-checkbox h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                                        <span class="ml-3 text-sm font-bold text-blue-800">Integral (Dia Todo)</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="md:col-span-1 flex flex-col">
                            <label for="observacao" class="block text-sm font-medium text-gray-700 mb-1">Observações (Opcional)</label>
                            <!-- Área de texto gerada pelo sistema (Bloqueada) -->
                            <div id="system-obs-readonly" class="bg-gray-100 text-gray-600 p-2 border border-gray-300 border-b-0 rounded-t-md text-xs font-mono whitespace-pre-wrap"></div>
                            <!-- Área de texto do usuário (Editável) -->
                            <textarea id="observacao" rows="2" class="w-full p-3 border border-gray-300 rounded-b-md rounded-t-none shadow-sm resize-none focus:ring-0 focus:border-gray-400" placeholder="Adicione mais detalhes aqui..."></textarea>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mt-4 text-sm text-blue-700">
                        <i class="fas fa-info-circle mr-2"></i>
                        Selecione a Data e os Períodos, depois clique no <b>+</b> para adicionar. O estoque será validado para todas as combinações no envio.
                    </div>

                    <h3 class="font-semibold text-lg mb-3 text-gray-700 mt-8">Itens Desejados</h3>
                    <div id="itens-list" class="space-y-4"></div>
                    <div class="mt-8 text-center">
                        <button type="submit" id="submit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105 w-full md:w-auto">
                            <i class="fas fa-calendar-check mr-2"></i>Enviar Solicitação(ões)
                        </button>
                    </div>
                </form>
            </div>

            <!-- Tab Content: Kits -->
            <div id="tab-content-kits" class="form-section">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-6">
                    <div>
                        <h3 class="font-semibold text-lg mb-3 text-gray-700">Kits Salvos</h3>
                        <div id="kits-list" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
                        <p id="kits-placeholder" class="text-center py-4 text-gray-500">Nenhum kit salvo.</p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg mb-3 text-gray-700" id="create-kit-title">Criar Novo Kit</h3>
                        <form id="create-kit-form" class="bg-gray-50 p-4 rounded-lg" novalidate>
                             <div class="mb-4">
                                <label for="kit-name" class="block text-sm font-medium text-gray-700 mb-1">Nome do Kit</label>
                                <input type="text" id="kit-name" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: Kit Aula de Artes" required>
                             </div>
                             <label class="block text-sm font-medium text-gray-700 mb-1">Itens do Kit</label>
                             <div id="kit-itens-list" class="space-y-3"></div>
                             
                             <div class="flex gap-2 mt-6">
                                <button type="button" id="cancel-edit-kit-btn" class="hidden w-1/3 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 rounded-lg transition-colors">Cancelar</button>
                                <button type="submit" id="submit-kit-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg transition-colors">Salvar Kit</button>
                             </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Histórico -->
            <div id="tab-content-historico" class="form-section">
                <div class="bg-white pt-6 rounded-lg">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Histórico de Solicitações</h2>
                    <div id="history-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
                    <p id="history-placeholder" class="text-center py-8 text-gray-500">Nenhuma solicitação encontrada.</p>
                </div>
            </div>

            <!-- Tab Content: Solicitar Compra (EM DESENVOLVIMENTO) -->
            <div id="tab-content-compra" class="form-section">
                <div class="flex flex-col items-center justify-center bg-white pt-10 pb-10 rounded-lg min-h-[300px]">
                    <div class="bg-blue-50 p-6 rounded-full mb-6">
                        <i class="fas fa-hammer text-6xl text-blue-400"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-700 mb-2">Em Desenvolvimento</h2>
                    <p class="text-gray-500 text-center max-w-md px-4">
                        O módulo de solicitação de compras externas está sendo aprimorado para melhor atendê-lo.
                    </p>
                    <span class="mt-4 px-4 py-2 bg-gray-100 text-gray-600 rounded-full text-sm font-mono border border-gray-200">
                        Status: Construção
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Monitor de Recursos Firebase (OCULTO) -->
    <div id="firebase-monitor" class="hidden fixed bottom-4 right-4 bg-gray-900 text-white p-4 rounded-lg shadow-2xl z-50 text-xs opacity-90 hover:opacity-100 transition-opacity">
        <div class="flex justify-between items-center mb-2 border-b border-gray-700 pb-1">
            <span class="font-bold text-green-400"><i class="fas fa-server mr-2"></i>Monitor Firebase</span>
            <button onclick="document.getElementById('firebase-monitor').style.display='none'" class="text-gray-500 hover:text-white ml-4">&times;</button>
        </div>
        <div class="grid grid-cols-2 gap-x-4 gap-y-2">
            <div>Leituras (Reads):</div>
            <div id="monitor-reads" class="text-right font-bold text-blue-400">0</div>
            
            <div>Gravações (Writes):</div>
            <div id="monitor-writes" class="text-right font-bold text-yellow-400">0</div>
            
            <div>Exclusões (Deletes):</div>
            <div id="monitor-deletes" class="text-right font-bold text-red-400">0</div>
        </div>
        <div class="mt-2 text-[10px] text-gray-500 text-center">
            *Estimativa de custo desta sessão
        </div>
    </div>

    <!-- Modals -->
    <div id="status-update-modal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center p-4 z-50 hidden modal-enter">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md text-center">
            <div id="status-update-icon-container" class="mx-auto flex items-center justify-center h-16 w-16 rounded-full mb-5"></div>
            <h3 id="status-update-title" class="text-2xl font-bold text-gray-800">Atualização de Pedido</h3>
            <p id="status-update-message" class="my-4 text-gray-600"></p>
            <button id="status-update-ok-btn" class="w-full text-white font-bold py-3 px-6 rounded-lg">OK</button>
        </div>
    </div>

    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center p-4 z-50 hidden modal-enter">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md text-center">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-5">
                <i class="fas fa-check text-4xl text-green-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800">Operação Realizada!</h3>
            <p id="success-message" class="my-4 text-gray-600"></p>
            <button id="success-ok-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg">OK</button>
        </div>
    </div>

    <div id="item-selection-modal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center p-4 z-50 hidden modal-enter">
        <div class="bg-gray-50 rounded-lg shadow-2xl p-6 w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-bold text-gray-800">Selecione um Item</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-red-600 text-2xl">&times;</button>
            </div>
            <div class="relative mb-4">
                <input type="text" id="item-search-input" placeholder="Buscar item..." class="w-full p-2 pl-10 border border-gray-300 rounded-md">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
            <div id="modal-items-container" class="space-y-2 overflow-y-auto pr-2"></div>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center p-4 z-50 hidden modal-enter">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md text-center">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-yellow-100 mb-5">
                <i class="fas fa-exclamation-triangle text-4xl text-yellow-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800">Confirmar Ação</h3>
            <p id="confirm-message" class="my-4 text-gray-600"></p>
            <div class="flex justify-center gap-4 mt-6">
                <button id="confirm-cancel-btn" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                <button id="confirm-ok-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, serverTimestamp, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- MONITOR DE RECURSOS FIREBASE ---
        let sessionReads = 0;
        let sessionWrites = 0;
        let sessionDeletes = 0;

        function updateMonitorUI() {
            document.getElementById('monitor-reads').textContent = sessionReads;
            document.getElementById('monitor-writes').textContent = sessionWrites;
            document.getElementById('monitor-deletes').textContent = sessionDeletes;
            
            // Efeito visual ao atualizar (removido para manter oculto o comportamento)
        }

        function countRead(qtd = 1) {
            if (qtd > 0) {
                sessionReads += qtd;
                updateMonitorUI();
            }
        }

        function countWrite(qtd = 1) {
            sessionWrites += qtd;
            updateMonitorUI();
        }

        function countDelete(qtd = 1) {
            sessionDeletes += qtd;
            updateMonitorUI();
        }
        // ------------------------------------

        const firebaseConfig = {
            apiKey: "AIzaSyCiSA3hcGqJ4BKtkxNrS9DBrEP4NcpxAVo",
            authDomain: "almoxeprojects.firebaseapp.com",
            projectId: "almoxeprojects",
            storageBucket: "almoxeprojects.appspot.com",
            messagingSenderId: "933670924253",
            appId: "1:933670924253:web:64f137671adeab3f201034",
            measurementId: "G-WDEKYB0Y20"
        };
        const appId = 'almoxarifado-app-global';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const getCollectionRef = (name) => collection(db, 'almoxarifado', appId, name);

        // State variables
        let localItems = []; 
        let globalPendingSolicitacoes = []; 
        let myPersonalSolicitacoes = []; 
        let localSolicitacoesCompra = [];
        let previousSolicitacoesState = new Map();
        let previousCompraState = new Map();
        let categorizedItems = {};
        let categoriesCache = null; 
        
        let currentProfessor = null;
        let activeItemRow = null;
        let unsubscribeItems = null;
        let unsubscribePending = null;
        let unsubscribeMyHistory = null;
        let unsubscribeSolicitacoesCompra = null;
        
        // New: Selected dates (with periods) for multi-request
        let selectedDates = []; // Format: [{ date: '2023-01-01', period: 'Manhã' }, ...]
        
        // Kit Editing State
        let editingKitId = null;
        let localKits = []; // Cache to facilitate editing

        // DOM Elements
        const matriculaInput = document.getElementById('solicitante-matricula');
        const form = document.getElementById('form-solicitacao');
        const tabsContainer = document.querySelector('.tabs-container');
        const professorInfoDiv = document.getElementById('professor-info');
        const professorNameDisplay = document.getElementById('professor-name-display');
        const matriculaError = document.getElementById('matricula-error');
        const matriculaFeedbackIcon = document.getElementById('matricula-feedback-icon');
        const acessarBtn = document.getElementById('acessar-btn');
        const trocarUsuarioBtn = document.getElementById('trocar-usuario-btn');
        const dataAgendamentoInput = document.getElementById('data-agendamento');
        const addDateBtn = document.getElementById('add-date-btn');
        const selectedDatesContainer = document.getElementById('selected-dates-container');
        const systemObsReadonly = document.getElementById('system-obs-readonly');
        
        // Kit Form Elements
        const createKitTitle = document.getElementById('create-kit-title');
        const createKitForm = document.getElementById('create-kit-form');
        const kitNameInput = document.getElementById('kit-name');
        const kitItemsList = document.getElementById('kit-itens-list');
        const submitKitBtn = document.getElementById('submit-kit-btn');
        const cancelEditKitBtn = document.getElementById('cancel-edit-kit-btn');
        
        // Custom Dropdown Elements
        const periodoDropdownBtn = document.getElementById('periodo-dropdown-btn');
        const periodoDropdownContent = document.getElementById('periodo-dropdown-content');
        const periodoSelectedText = document.getElementById('periodo-selected-text');
        const periodosContainer = document.getElementById('periodos-container');

        // Modals
        const itemModal = document.getElementById('item-selection-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalItemsContainer = document.getElementById('modal-items-container');
        const itemSearchInput = document.getElementById('item-search-input');
        const successModal = document.getElementById('success-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const statusUpdateModal = document.getElementById('status-update-modal');

        function attachRealtimeListeners() {
            if (unsubscribeItems) unsubscribeItems(); 
            if (unsubscribePending) unsubscribePending();
            if (unsubscribeMyHistory) unsubscribeMyHistory();
            if (unsubscribeSolicitacoesCompra) unsubscribeSolicitacoesCompra();

            unsubscribeItems = onSnapshot(getCollectionRef('itens'), (snapshot) => {
                countRead(snapshot.docChanges().length);
                localItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Recalcular validações se itens mudarem
                revalidateAllRows();
            }, (error) => console.error("Erro ao ouvir itens:", error));

            const qPending = query(getCollectionRef('solicitacoes'), where("status", "==", "Pendente"));
            unsubscribePending = onSnapshot(qPending, (snapshot) => {
                countRead(snapshot.docChanges().length);
                globalPendingSolicitacoes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Recalcular validações se houver novas reservas
                revalidateAllRows();
            }, (error) => console.error("Erro ao ouvir pendentes:", error));

            const qMyHistory = query(getCollectionRef('solicitacoes'), where("solicitanteId", "==", currentProfessor.id));
            unsubscribeMyHistory = onSnapshot(qMyHistory, (snapshot) => {
                countRead(snapshot.docChanges().length);
                const newSolicitacoes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                newSolicitacoes.forEach(sol => {
                    const oldStatus = previousSolicitacoesState.get(sol.id);
                    if (oldStatus && oldStatus !== sol.status) {
                        if (oldStatus === 'Pendente' && sol.status === 'Concluída') {
                            showStatusUpdateModal(`Seu pedido para ${new Date(sol.dataAgendamento + 'T00:00:00').toLocaleDateString('pt-BR')} foi aceito e está sendo separado!`, 'success');
                        } else if (oldStatus === 'Pendente' && sol.status === 'Rejeitada') {
                            showStatusUpdateModal(`Sua solicitação para ${new Date(sol.dataAgendamento + 'T00:00:00').toLocaleDateString('pt-BR')} foi recusada.`, 'error');
                        }
                    }
                });
                
                previousSolicitacoesState.clear();
                newSolicitacoes.forEach(sol => previousSolicitacoesState.set(sol.id, sol.status));
                
                myPersonalSolicitacoes = newSolicitacoes;
                displayHistory();
            }, (error) => console.error("Erro ao ouvir histórico:", error));


            // Listener de Compras mantido apenas para o HISTÓRICO, o formulário de envio está desativado
            const qCompras = query(getCollectionRef('solicitacoes_compra'), where("solicitanteId", "==", currentProfessor.id));
            unsubscribeSolicitacoesCompra = onSnapshot(qCompras, (snapshot) => {
                countRead(snapshot.docChanges().length);
                const newSolicitacoes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                newSolicitacoes.forEach(sol => {
                    const oldStatus = previousCompraState.get(sol.id);
                    if (oldStatus && oldStatus !== sol.status) {
                        if (oldStatus === 'Pendente de Aprovação' && sol.status === 'Aprovado') {
                            showStatusUpdateModal(`Seu pedido de compra para "${sol.itemName}" foi APROVADO pelo supervisor!`, 'success');
                        } else if (oldStatus === 'Pendente de Aprovação' && sol.status === 'Rejeitado') {
                            showStatusUpdateModal(`Seu pedido de compra para "${sol.itemName}" foi REJEITADO pelo supervisor.`, 'error');
                        }
                    }
                });

                previousCompraState.clear();
                newSolicitacoes.forEach(sol => previousCompraState.set(sol.id, sol.status));
                localSolicitacoesCompra = newSolicitacoes;
                displayHistory();
            }, (error) => console.error("Erro ao ouvir compras:", error));
        }

        // --- Dropdown Logic ---
        
        function toggleDropdown() {
            periodoDropdownContent.classList.toggle('hidden');
            const icon = periodoDropdownBtn.querySelector('i');
            if (periodoDropdownContent.classList.contains('hidden')) {
                icon.classList.remove('rotate-180');
            } else {
                icon.classList.add('rotate-180');
                icon.classList.add('transition-transform');
            }
        }

        function closeDropdown() {
            periodoDropdownContent.classList.add('hidden');
            const icon = periodoDropdownBtn.querySelector('i');
            icon.classList.remove('rotate-180');
        }

        periodoDropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleDropdown();
        });

        document.addEventListener('click', (e) => {
            if (!periodoDropdownContent.contains(e.target) && !periodoDropdownBtn.contains(e.target)) {
                closeDropdown();
            }
        });

        // Function to update the button text based on selection
        function updateSelectedPeriodsText() {
            const selected = getSelectedPeriods();
            if (selected.length === 0) {
                periodoSelectedText.textContent = "Selecione...";
            } else if (selected.includes("Integral")) {
                periodoSelectedText.textContent = "Integral (Dia Todo)";
            } else {
                periodoSelectedText.textContent = selected.join(', ');
            }
        }

        function getSelectedPeriods() {
            const checkboxes = periodosContainer.querySelectorAll('input[name="periodo"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // Logic to ensure "Integral" behaves exclusively
        periodosContainer.addEventListener('change', (e) => {
            if (e.target.name === 'periodo') {
                const val = e.target.value;
                const isChecked = e.target.checked;
                
                if (val === 'Integral' && isChecked) {
                    // Uncheck others
                    periodosContainer.querySelectorAll('input[name="periodo"]').forEach(cb => {
                        if (cb.value !== 'Integral') cb.checked = false;
                    });
                } else if (val !== 'Integral' && isChecked) {
                    // Uncheck Integral
                    const integralCb = periodosContainer.querySelector('input[value="Integral"]');
                    if (integralCb) integralCb.checked = false;
                }
                
                updateSelectedPeriodsText();
                revalidateAllRows();
                renderSystemObs();
            }
        });

        // Função unificada para calcular estoque e quem está com o item
        function calculateStockAndHolders(item, targetDateStr, targetPeriod) {
            const currentPhysicalStock = item.quantity || 0;
            let reservationsOnDate = 0;
            const holders = new Set(); // Use Set para nomes únicos
            
            // Lógica de Interseção de Períodos
            for (const sol of globalPendingSolicitacoes) {
                // Verifica data exata
                if (sol.dataAgendamento && sol.dataAgendamento === targetDateStr) {
                    
                    const solPeriod = sol.periodo || 'Integral'; 
                    let isConflict = false;
                    
                    if (targetPeriod === 'Integral') {
                        isConflict = true; 
                    } else if (solPeriod === 'Integral') {
                        isConflict = true;
                    } else if (targetPeriod === solPeriod) {
                        isConflict = true;
                    }

                    if (isConflict) {
                        for (const solItem of sol.itensSolicitados) {
                            if (solItem.itemId === item.id) {
                                reservationsOnDate += solItem.quantidade;
                                // Adiciona o nome do solicitante à lista de "quem está com o item"
                                if(sol.solicitanteName) {
                                    holders.add(sol.solicitanteName);
                                }
                            }
                        }
                    }
                }
            }
            
            return {
                availableStock: currentPhysicalStock - reservationsOnDate,
                holders: Array.from(holders)
            };
        }

        function getAvailableStock(item, targetDateStr, targetPeriod) {
            return calculateStockAndHolders(item, targetDateStr, targetPeriod).availableStock;
        }

        function handleStockValidation(rowDiv) {
            const itemId = rowDiv.dataset.itemId;
            if (!itemId) return;

            const item = localItems.find(i => i.id === itemId);
            if (!item) return;
            
            // Context check: If it's a Kit Creation row, validate against physical stock only
            const isKitCreation = rowDiv.closest('#kit-itens-list');

            const quantityInput = rowDiv.querySelector('.item-quantity-input');
            const errorP = rowDiv.querySelector('.error-message');
            const requestedQuantity = parseInt(quantityInput.value, 10);

            if (isKitCreation) {
                const physicalStock = item.quantity || 0;
                if (!isNaN(requestedQuantity) && requestedQuantity > physicalStock) {
                     errorP.textContent = `Máx físico: ${physicalStock}`;
                     errorP.classList.remove('hidden');
                     quantityInput.classList.add('border-red-500');
                } else {
                     errorP.classList.add('hidden');
                     quantityInput.classList.remove('border-red-500');
                }
                return;
            }

            // Normal Request Validation
            const targetDate = dataAgendamentoInput.value;
            const selectedPeriods = getSelectedPeriods();
            
            if (selectedPeriods.length === 0) {
                errorP.textContent = "Selecione um período.";
                errorP.classList.remove('hidden');
                return;
            }

            // Check availability for ALL selected periods
            let hasError = false;
            let errorMsg = "Disp: ";
            let details = [];

            selectedPeriods.forEach(period => {
                const avail = getAvailableStock(item, targetDate, period);
                const shortPeriod = period.substring(0, 1); // M, T, N, I
                details.push(`${avail} (${shortPeriod})`);
                
                if (!isNaN(requestedQuantity) && requestedQuantity > avail) {
                    hasError = true;
                }
            });
            
            if (hasError) {
                errorP.textContent = errorMsg + details.join(', ');
                errorP.classList.remove('hidden');
                quantityInput.classList.add('border-red-500');
            } else {
                errorP.classList.add('hidden');
                quantityInput.classList.remove('border-red-500');
            }
        }

        // Função auxiliar para revalidar todas as linhas quando data/periodo muda
        function revalidateAllRows() {
            document.querySelectorAll('#itens-list .item-row').forEach(row => {
                handleStockValidation(row);
            });
        }

        function createItemRow(containerId, itemData = null) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'item-row flex flex-col sm:flex-row items-stretch sm:items-center gap-2 p-3 bg-white rounded-lg border';
            
            const itemName = itemData ? itemData.itemName : 'Clique para selecionar um item...';
            const itemQuantity = itemData ? itemData.quantidade : '';
            if (itemData?.itemId) {
                div.dataset.itemId = itemData.itemId;
            }

            div.innerHTML = `
                <div class="flex-grow">
                    <button type="button" class="item-select-btn w-full p-2 border border-gray-300 rounded-md text-left ${itemData ? 'text-gray-800' : 'text-gray-400'}">
                        ${itemName}
                    </button>
                    <p class="error-message text-red-600 text-xs font-semibold mt-1 ml-1 hidden"></p>
                </div>
                <div class="flex items-center gap-2">
                    <input type="number" class="item-quantity-input w-24 p-2 border-gray-300 rounded-md" placeholder="Qtd" min="1" value="${itemQuantity}">
                    <button type="button" class="remove-item-btn text-red-500 hover:text-red-700 text-lg p-2" title="Remover Item">
                        <i class="fas fa-minus-circle"></i>
                    </button>
                </div>
            `;
            container.appendChild(div);
            
            div.querySelector('.item-quantity-input').addEventListener('input', () => handleStockValidation(div));
            div.querySelector('.item-select-btn').addEventListener('click', () => {
                activeItemRow = div;
                openItemModal();
            });

            if(itemData) handleStockValidation(div);
        }

        async function openItemModal() {
            modalItemsContainer.innerHTML = '';
            categorizedItems = {}; 
            
            // Check Context: Is this for Kit Creation?
            const isKitCreation = activeItemRow && activeItemRow.closest('#kit-itens-list');

            const targetDate = dataAgendamentoInput.value;
            const selectedPeriods = getSelectedPeriods();
            const targetPeriodForModal = selectedPeriods.length > 0 ? selectedPeriods : ['Manhã']; 

            if (!categoriesCache) {
                categoriesCache = new Map();
                try {
                    const categoriesSnapshot = await getDocs(getCollectionRef('categories'));
                    countRead(categoriesSnapshot.size);
                    categoriesSnapshot.forEach(doc => {
                        categoriesCache.set(doc.id, doc.data().name);
                    });
                } catch (error) {
                    console.error("Erro ao carregar categorias no modal:", error);
                }
            }
            const categoriesMap = categoriesCache;

            localItems.forEach(item => {
                let minAvail = 9999;
                let allHolders = new Set();
                
                if (isKitCreation) {
                    // For Kit Creation: Ignore date reservations, use physical stock
                    minAvail = item.quantity || 0;
                } else {
                    // For Request: Calculate based on reservations
                    targetPeriodForModal.forEach(p => {
                        const { availableStock, holders } = calculateStockAndHolders(item, targetDate, p);
                        if (availableStock < minAvail) minAvail = availableStock;
                        holders.forEach(h => allHolders.add(h));
                    });
                }
                
                const holdersList = Array.from(allHolders);

                const categoryName = categoriesMap.get(item.categoryId) || 'Outros';
                if (!categorizedItems[categoryName]) {
                    categorizedItems[categoryName] = [];
                }
                categorizedItems[categoryName].push({ ...item, availableStock: minAvail, holders: holdersList });
            });

            const sortedCategories = Object.keys(categorizedItems).sort();
            sortedCategories.forEach(category => {
                const details = document.createElement('details');
                details.className = 'category-accordion bg-white rounded-lg border';
                details.innerHTML = `
                    <summary class="flex justify-between items-center p-3 font-semibold text-gray-700 hover:bg-gray-100">
                        <span>${category}</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </summary>
                    <div class="items-grid p-3 border-t grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2"></div>
                `;
                
                const itemsGrid = details.querySelector('.items-grid');
                categorizedItems[category].forEach(item => {
                    const itemButton = document.createElement('button');
                    itemButton.type = 'button';
                    
                    const isUnavailable = item.availableStock <= 0;
                    
                    if (isUnavailable) {
                        // Estilo para item indisponível
                        itemButton.className = `item-button text-left p-2 rounded-md bg-red-50 border border-red-200 opacity-80 cursor-not-allowed`;
                        itemButton.disabled = true; // Desabilita o clique
                        
                        const holdersText = !isKitCreation && item.holders && item.holders.length > 0 
                            ? `Com: ${item.holders.join(', ')}` 
                            : 'Indisponível';
                            
                        itemButton.innerHTML = `
                            <span class="font-semibold text-gray-500">${item.name}</span>
                            <div class="flex flex-col mt-1">
                                <span class="text-xs text-red-600 font-bold uppercase"><i class="fas fa-ban mr-1"></i>Esgotado</span>
                                <span class="text-[10px] text-gray-600 truncate" title="${holdersText}">${holdersText}</span>
                            </div>
                        `;
                    } else {
                        // Estilo normal
                        itemButton.className = `item-button text-left p-2 rounded-md bg-gray-50 hover:bg-blue-100 border border-gray-200`;
                        itemButton.dataset.itemName = item.name;
                        
                        const stockLabel = isKitCreation ? 'Total Físico' : 'Disp';

                        itemButton.innerHTML = `
                            <span class="font-semibold text-gray-700">${item.name}</span>
                            <div class="flex justify-between items-center">
                                <span class="block text-xs text-gray-500">${stockLabel}: ${item.availableStock}</span>
                            </div>
                        `;
                        itemButton.addEventListener('click', () => selectItemFromModal(item));
                    }

                    itemsGrid.appendChild(itemButton);
                });

                modalItemsContainer.appendChild(details);
            });

            itemModal.classList.remove('hidden');
            itemSearchInput.value = ''; 
            itemSearchInput.focus();
        }

        function filterItems() {
            const searchTerm = itemSearchInput.value.toLowerCase();
            const categories = modalItemsContainer.querySelectorAll('.category-accordion');

            categories.forEach(category => {
                const categoryName = category.querySelector('summary span').textContent.toLowerCase();
                const items = category.querySelectorAll('.item-button');
                let hasVisibleItem = false;

                items.forEach(item => {
                    // Para itens desabilitados que podem não ter dataset.itemName no click, 
                    // precisamos pegar o nome de dentro do span
                    const nameElement = item.querySelector('span.font-semibold');
                    const itemName = nameElement ? nameElement.textContent.toLowerCase() : '';
                    
                    if (itemName.includes(searchTerm)) {
                        item.style.display = 'block';
                        hasVisibleItem = true;
                    } else {
                        item.style.display = 'none';
                    }
                });

                if (hasVisibleItem || categoryName.includes(searchTerm)) {
                    category.style.display = 'block';
                    if (searchTerm) {
                        category.open = true;
                    }
                } else {
                    category.style.display = 'none';
                }
            });
        }
        
        function selectItemFromModal(item) {
            if (activeItemRow) {
                const btn = activeItemRow.querySelector('.item-select-btn');
                btn.textContent = item.name;
                btn.classList.remove('text-gray-400');
                activeItemRow.dataset.itemId = item.id;
                handleStockValidation(activeItemRow);

                const container = activeItemRow.parentElement;
                const containerId = container.id;
                const isLastRow = activeItemRow === container.lastElementChild;

                if (isLastRow && (containerId === 'itens-list' || containerId === 'kit-itens-list')) {
                    createItemRow(containerId);
                }
            }
            closeItemModal();
        }

        function closeItemModal() {
            itemModal.classList.add('hidden');
            activeItemRow = null;
        }

        function displayHistory() {
            if (!currentProfessor) return;
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            
            const professorSolicitations = myPersonalSolicitacoes.map(s => ({ ...s, type: 'retirada' }));
            const professorCompraSolicitations = localSolicitacoesCompra.map(s => ({ ...s, type: 'compra' }));

            const allHistory = [...professorSolicitations, ...professorCompraSolicitations];
            allHistory.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
            
            document.getElementById('history-placeholder').classList.toggle('hidden', allHistory.length > 0);
            
            allHistory.forEach(solicitacao => {
                const div = document.createElement('div');
                div.className = 'p-4 border rounded-lg bg-gray-50';
                
                if (solicitacao.type === 'retirada') {
                    const statusClasses = { 'Pendente': 'bg-yellow-100 text-yellow-800', 'Concluída': 'bg-green-100 text-green-800', 'Rejeitada': 'bg-red-100 text-red-800', 'Cancelado': 'bg-gray-200 text-gray-700' };
                    const dataAgendada = solicitacao.dataAgendamento ? new Date(solicitacao.dataAgendamento + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A';
                    const dataPedido = solicitacao.timestamp ? solicitacao.timestamp.toDate().toLocaleDateString('pt-BR') : 'N/A';
                    const periodo = solicitacao.periodo || 'Integral';
                    
                    const actionButtons = [];
                    if (solicitacao.status === 'Pendente') {
                        actionButtons.push(`<button data-id="${solicitacao.id}" data-type="retirada" class="cancel-solicitacao-btn text-xs bg-red-100 text-red-700 hover:bg-red-200 font-semibold py-1 px-2 rounded">Cancelar</button>`);
                    }
                    actionButtons.push(`<button data-solicitacao-items='${JSON.stringify(solicitacao.itensSolicitados)}' data-periodo="${periodo}" class="reutilizar-btn text-xs bg-blue-100 text-blue-700 hover:bg-blue-200 font-semibold py-1 px-2 rounded">Reutilizar Pedido</button>`);

                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold text-gray-700">Pedido de Material: ${dataPedido} <span class="font-normal text-gray-500">(Para: ${dataAgendada} - ${periodo})</span></p>
                                <div class="text-xs text-gray-600 mt-2">
                                    ${solicitacao.itensSolicitados.map(item => `<span>- ${item.quantidade}x ${item.itemName}</span>`).join('<br>')}
                                </div>
                            </div>
                            <span class="text-xs font-bold px-2 py-1 rounded-full ${statusClasses[solicitacao.status] || ''}">${solicitacao.status}</span>
                        </div>
                        <div class="flex justify-end gap-2 mt-3">
                            ${actionButtons.join('')}
                        </div>`;
                } else { 
                    const statusClasses = { 
                        'Pendente de Aprovação': 'bg-gray-200 text-gray-800',
                        'Aprovado': 'bg-blue-100 text-blue-800',
                        'Rejeitado': 'bg-red-100 text-red-800',
                        'Em Análise': 'bg-yellow-100 text-yellow-800',
                        'Comprado': 'bg-indigo-100 text-indigo-800',
                        'Entregue': 'bg-green-100 text-green-800',
                        'Cancelado': 'bg-gray-200 text-gray-700'
                    };
                    const dataPedido = solicitacao.timestamp ? solicitacao.timestamp.toDate().toLocaleDateString('pt-BR') : 'N/A';
                    const cancelButton = solicitacao.status === 'Pendente de Aprovação' 
                        ? `<button data-id="${solicitacao.id}" data-type="compra" class="cancel-solicitacao-btn ml-2 text-xs bg-red-100 text-red-700 hover:bg-red-200 font-semibold py-1 px-2 rounded">Cancelar</button>`
                        : '';
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold text-gray-700">Pedido de Compra: ${dataPedido}</p>
                                <div class="text-xs text-gray-600 mt-2">
                                    <p><b>Item:</b> ${solicitacao.itemName} (Qtd: ${solicitacao.quantidade})</p>
                                    <p><b>Descrição:</b> ${solicitacao.itemDescricao}</p>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <span class="text-xs font-bold px-2 py-1 rounded-full ${statusClasses[solicitacao.status] || ''}">${solicitacao.status}</span>
                                ${cancelButton}
                            </div>
                        </div>`;
                }
                historyList.appendChild(div);
            });
        }

        function resetRequestForm() {
            document.getElementById('observacao').value = '';
            document.getElementById('itens-list').innerHTML = '';
            const today = new Date().toISOString().split('T')[0];
            dataAgendamentoInput.value = today;
            dataAgendamentoInput.min = today;
            
            // Reset checkboxes
            periodosContainer.querySelectorAll('input[name="periodo"]').forEach(cb => {
                cb.checked = (cb.value === 'Manhã');
            });
            updateSelectedPeriodsText();
            
            selectedDates = [];
            renderSelectedDates();
            
            createItemRow('itens-list');
        }
        
        // Multi-date handling functions
        function renderSelectedDates() {
            selectedDatesContainer.innerHTML = '';
            selectedDates.forEach(dateObj => {
                const dateStr = dateObj.date;
                const periodStr = dateObj.period;
                
                const dateInstance = new Date(dateStr + 'T00:00:00');
                const formattedDate = dateInstance.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                
                const tag = document.createElement('div');
                tag.className = 'date-tag bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded-full flex items-center gap-1';
                tag.innerHTML = `
                    <span>${formattedDate} (${periodStr})</span>
                    <button type="button" class="hover:text-red-500 focus:outline-none" aria-label="Remover data">
                        &times;
                    </button>
                `;
                
                tag.querySelector('button').addEventListener('click', () => {
                    // Remove exact match of date AND period
                    selectedDates = selectedDates.filter(d => !(d.date === dateStr && d.period === periodStr));
                    renderSelectedDates();
                });
                
                selectedDatesContainer.appendChild(tag);
            });
            
            // Atualiza também o resumo da observação
            renderSystemObs();
        }
        
        // Função para renderizar o resumo de agendamento na observação
        function renderSystemObs() {
            let text = "Agendamento para:\n";
            
            // Determina quais datas mostrar: a lista de selecionados OU o input atual (como no envio)
            let datesToShow = [];
            if (selectedDates.length > 0) {
                datesToShow = selectedDates;
            } else {
                const currentPeriods = getSelectedPeriods();
                if (dataAgendamentoInput.value && currentPeriods.length > 0) {
                    currentPeriods.forEach(p => {
                        datesToShow.push({ date: dataAgendamentoInput.value, period: p });
                    });
                }
            }

            if (datesToShow.length === 0) {
                text += "(Selecione uma data)";
            } else {
                datesToShow.forEach(d => {
                    const dateObj = new Date(d.date + 'T00:00:00');
                    const formatted = dateObj.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
                    text += `- ${formatted} (${d.period})\n`;
                });
            }
            systemObsReadonly.textContent = text;
        }
        
        addDateBtn.addEventListener('click', () => {
            const dateVal = dataAgendamentoInput.value;
            const selectedPeriods = getSelectedPeriods();
            
            if (!dateVal) return;
            if (selectedPeriods.length === 0) {
                alert('Selecione pelo menos um período.');
                return;
            }
            
            let addedCount = 0;
            selectedPeriods.forEach(periodVal => {
                // Check if combination already exists
                const exists = selectedDates.some(d => d.date === dateVal && d.period === periodVal);
                
                if (!exists) {
                    selectedDates.push({ date: dateVal, period: periodVal });
                    addedCount++;
                }
            });
            
            if (addedCount > 0) {
                // Sort chronologically then by period
                selectedDates.sort((a, b) => {
                    if (a.date !== b.date) return a.date.localeCompare(b.date);
                    return a.period.localeCompare(b.period);
                });
                renderSelectedDates();
                // Opcional: Feedback visual ao adicionar
                addDateBtn.classList.add('bg-green-100', 'text-green-700');
                setTimeout(() => {
                    addDateBtn.classList.remove('bg-green-100', 'text-green-700');
                }, 300);
            } else {
                alert('Esta data e período já foram adicionados à lista.');
            }
        });

        function resetKitForm() {
            createKitForm.reset();
            kitItemsList.innerHTML = '';
            createItemRow('kit-itens-list');
            
            // Reset Edit Mode
            editingKitId = null;
            createKitTitle.textContent = "Criar Novo Kit";
            submitKitBtn.textContent = "Salvar Kit";
            submitKitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            submitKitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            cancelEditKitBtn.classList.add('hidden');
        }
        
        function startEditingKit(kit) {
            editingKitId = kit.id;
            
            // Scroll to form
            createKitForm.scrollIntoView({ behavior: 'smooth' });
            
            // Populate Fields
            kitNameInput.value = kit.kitName;
            
            // Populate Items
            kitItemsList.innerHTML = '';
            if (kit.items && kit.items.length > 0) {
                kit.items.forEach(item => {
                    createItemRow('kit-itens-list', item);
                });
            }
            createItemRow('kit-itens-list'); // Add empty row
            
            // Change UI
            createKitTitle.textContent = "Editando Kit";
            submitKitBtn.textContent = "Atualizar Kit";
            submitKitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            submitKitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            cancelEditKitBtn.classList.remove('hidden');
        }
        
        cancelEditKitBtn.addEventListener('click', resetKitForm);

        function showSuccessModal(message, callback) {
            document.getElementById('success-message').textContent = message;
            successModal.classList.remove('hidden');
            const okBtn = document.getElementById('success-ok-btn');
            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            newOkBtn.addEventListener('click', () => {
                successModal.classList.add('hidden');
                if (callback) callback();
            });
        }

        function showConfirmModal(message, onConfirm) {
            document.getElementById('confirm-message').textContent = message;
            confirmModal.classList.remove('hidden');
            const okBtn = document.getElementById('confirm-ok-btn');
            const cancelBtn = document.getElementById('confirm-cancel-btn');
            
            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);

            newOkBtn.onclick = () => {
                confirmModal.classList.add('hidden');
                onConfirm();
            };
            cancelBtn.onclick = () => confirmModal.classList.add('hidden');
        }

        function showStatusUpdateModal(message, type) {
            const iconContainer = document.getElementById('status-update-icon-container');
            const okBtn = document.getElementById('status-update-ok-btn');
            
            if (type === 'success') {
                iconContainer.innerHTML = `<i class="fas fa-check-circle text-4xl text-green-600"></i>`;
                iconContainer.className = 'mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-5';
                okBtn.className = 'w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg';
            } else { // error
                iconContainer.innerHTML = `<i class="fas fa-times-circle text-4xl text-red-600"></i>`;
                iconContainer.className = 'mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 mb-5';
                okBtn.className = 'w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg';
            }
            
            document.getElementById('status-update-message').textContent = message;
            statusUpdateModal.classList.remove('hidden');
        }

        async function renderKits() {
            if (!currentProfessor) return;
            const kitsList = document.getElementById('kits-list');
            kitsList.innerHTML = '';
            const q = query(getCollectionRef('kits'), where("professorId", "==", currentProfessor.id));
            const querySnapshot = await getDocs(q);
            
            // Monitor: Contagem de leitura dos Kits
            countRead(querySnapshot.size);

            document.getElementById('kits-placeholder').classList.toggle('hidden', !querySnapshot.empty);
            
            localKits = []; // Reset local cache
            
            querySnapshot.forEach(doc => {
                const kit = { id: doc.id, ...doc.data() };
                localKits.push(kit);
                
                const div = document.createElement('div');
                div.className = 'p-4 border rounded-lg bg-white';
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-gray-800">${kit.kitName}</p>
                            <div class="text-xs text-gray-500 mt-1">
                                ${kit.items.map(i => `<span>${i.quantidade}x ${i.itemName}</span>`).join('<br>')}
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button data-id="${kit.id}" class="edit-kit-btn text-blue-400 hover:text-blue-600 text-sm" title="Editar Kit"><i class="fas fa-edit"></i></button>
                            <button data-id="${kit.id}" class="delete-kit-btn text-red-400 hover:text-red-600 text-sm" title="Excluir Kit"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <button data-kit-items='${JSON.stringify(kit.items)}' class="use-kit-btn mt-3 w-full bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold py-1 px-3 rounded text-sm">Usar este Kit</button>
                `;
                kitsList.appendChild(div);
            });
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            resetRequestForm();
            createItemRow('kit-itens-list');
        });

        // Listener para Data e Período - Revalidar estoque ao mudar e atualizar resumo obs
        dataAgendamentoInput.addEventListener('change', () => {
            revalidateAllRows();
            renderSystemObs();
        });
        // Note: periodosContainer listener already handled above

        acessarBtn.addEventListener('click', async () => {
            const matricula = matriculaInput.value.trim();
            if (!matricula) return;

            acessarBtn.disabled = true;
            acessarBtn.textContent = '...';

            // OTIMIZAÇÃO: Busca apenas o professor específico em vez de todos
            const q = query(getCollectionRef('professores'), where("matricula", "==", matricula));
            
            try {
                const querySnapshot = await getDocs(q);
                countRead(querySnapshot.size); // Deve ser 1

                if (!querySnapshot.empty) {
                    const doc = querySnapshot.docs[0];
                    const professor = { id: doc.id, ...doc.data() };
                    
                    currentProfessor = professor;
                    professorNameDisplay.textContent = professor.name;
                    professorInfoDiv.classList.remove('hidden');
                    tabsContainer.classList.add('active');
                    document.getElementById('tab-content-solicitacao').classList.add('active');
                    
                    acessarBtn.classList.add('hidden');
                    trocarUsuarioBtn.classList.remove('hidden');
                    matriculaInput.disabled = true;
                    matriculaError.classList.add('hidden');
                    matriculaFeedbackIcon.className = 'matricula-feedback absolute right-3 top-1/2 -translate-y-1/2 text-lg opacity-0';

                    attachRealtimeListeners(); 
                    renderKits();
                } else {
                    matriculaError.textContent = 'Matrícula não encontrada.';
                    matriculaError.classList.remove('hidden');
                    matriculaFeedbackIcon.className = 'matricula-feedback absolute right-3 top-1/2 -translate-y-1/2 text-lg opacity-100 fas fa-times-circle text-red-500';
                }
            } catch (error) {
                console.error("Erro no login:", error);
            } finally {
                acessarBtn.disabled = false;
                acessarBtn.textContent = 'Acessar';
            }
        });

        trocarUsuarioBtn.addEventListener('click', () => {
            if (unsubscribeItems) unsubscribeItems(); 
            if (unsubscribePending) unsubscribePending();
            if (unsubscribeMyHistory) unsubscribeMyHistory();
            if (unsubscribeSolicitacoesCompra) unsubscribeSolicitacoesCompra();
            location.reload();
        });

        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const tab = button.dataset.tab;
                document.querySelectorAll('.form-section').forEach(sec => sec.classList.remove('active'));
                document.getElementById(`tab-content-${tab}`).classList.add('active');
            });
        });

        function addRemoveListener(containerId) {
            document.getElementById(containerId).addEventListener('click', e => {
                const removeBtn = e.target.closest('.remove-item-btn');
                const container = document.getElementById(containerId);
                if (removeBtn && container.children.length > 1) {
                    removeBtn.closest('.item-row').remove();
                }
            });
        }
        addRemoveListener('itens-list');
        addRemoveListener('kit-itens-list');

        form.addEventListener('submit', async e => {
            e.preventDefault();
            if (!currentProfessor) return;

            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Enviando...';
            
            // Determine which dates to process
            let datesToProcess = [];
            if (selectedDates.length > 0) {
                // Use the list of objects { date, period }
                datesToProcess = selectedDates;
            } else {
                // Check if user filled inputs but didn't click "+"
                const dateVal = dataAgendamentoInput.value;
                const currentPeriods = getSelectedPeriods();
                if (dateVal && currentPeriods.length > 0) {
                    currentPeriods.forEach(p => {
                        datesToProcess.push({ date: dateVal, period: p });
                    });
                }
            }
            
            if (datesToProcess.length === 0) {
                alert('Selecione pelo menos uma data e período.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-calendar-check mr-2"></i>Enviar Solicitação(ões)';
                return;
            }

            const itensSolicitados = [];
            
            // Step 1: Collect Items
            for (const row of document.querySelectorAll('#itens-list .item-row')) {
                const itemId = row.dataset.itemId;
                const quantity = parseInt(row.querySelector('.item-quantity-input').value, 10);

                if (!itemId || !quantity || quantity <= 0) continue;
                
                // Get item details for validation
                const item = localItems.find(i => i.id === itemId);
                if(item) {
                     itensSolicitados.push({ 
                        itemId, 
                        itemName: row.querySelector('.item-select-btn').textContent.trim(), 
                        quantidade: quantity,
                        // Internal reference for validation
                        _stockItem: item 
                    });
                }
            }

            if (itensSolicitados.length === 0) {
                alert('Adicione pelo menos um item válido à solicitação.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-calendar-check mr-2"></i>Enviar Solicitação(ões)';
                return;
            }
            
            // Step 2: Validate Stock for ALL dates
            let globalValidationPass = true;
            
            for (const dateObj of datesToProcess) {
                for (const reqItem of itensSolicitados) {
                    const available = getAvailableStock(reqItem._stockItem, dateObj.date, dateObj.period);
                    if (reqItem.quantidade > available) {
                        alert(`Estoque insuficiente para o item "${reqItem.itemName}" na data ${new Date(dateObj.date + 'T00:00:00').toLocaleDateString('pt-BR')} (${dateObj.period}).\nDisponível: ${available}, Solicitado: ${reqItem.quantidade}`);
                        globalValidationPass = false;
                        break;
                    }
                }
                if (!globalValidationPass) break;
            }
            
            if (!globalValidationPass) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-calendar-check mr-2"></i>Enviar Solicitação(ões)';
                return;
            }

            // Step 3: Remove internal props and Send
            const cleanItens = itensSolicitados.map(({_stockItem, ...rest}) => rest);
            
            // Combinar observação do sistema com observação do usuário
            const systemObs = document.getElementById('system-obs-readonly').innerText;
            const userObs = document.getElementById('observacao').value.trim();
            const finalObservacao = systemObs + (userObs ? '\n\nDetalhes:\n' + userObs : '');

            try {
                // Generate a request for EACH date
                const promises = datesToProcess.map(dateObj => {
                    return addDoc(getCollectionRef('solicitacoes'), {
                        solicitanteId: currentProfessor.id,
                        solicitanteName: currentProfessor.name,
                        itensSolicitados: cleanItens,
                        dataAgendamento: dateObj.date,
                        periodo: dateObj.period, 
                        observacao: finalObservacao, // Usa a observação combinada
                        status: 'Pendente',
                        timestamp: serverTimestamp()
                    });
                });
                
                await Promise.all(promises);
                
                // Monitor: Contagem de gravação
                countWrite(datesToProcess.length);

                showSuccessModal(`Sucesso! Foram gerados ${datesToProcess.length} pedido(s).`, () => {
                    resetRequestForm();
                });
            } catch (error) {
                console.error("Erro ao enviar solicitação:", error);
                alert("Ocorreu um erro ao enviar a solicitação. Tente novamente.");
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-calendar-check mr-2"></i>Enviar Solicitação(ões)';
            }
        });

        createKitForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const kitName = document.getElementById('kit-name').value.trim();
            if (!kitName) { alert('Por favor, dê um nome ao seu kit.'); return; }

            const items = [];
            for (const row of document.querySelectorAll('#kit-itens-list .item-row')) {
                const itemId = row.dataset.itemId;
                const quantity = parseInt(row.querySelector('.item-quantity-input').value, 10);

                if (!itemId || !quantity || quantity <= 0) continue;
                
                items.push({ 
                    itemId, 
                    itemName: row.querySelector('.item-select-btn').textContent.trim(), 
                    quantidade: quantity 
                });
            }

            if (items.length === 0) {
                alert('Adicione pelo menos um item válido ao kit.');
                return;
            }

            try {
                if (editingKitId) {
                    // Update existing kit
                    await updateDoc(doc(db, 'almoxarifado', appId, 'kits', editingKitId), {
                        kitName,
                        items
                    });
                    showSuccessModal('Seu kit foi atualizado com sucesso!');
                } else {
                    // Create new kit
                    await addDoc(getCollectionRef('kits'), { professorId: currentProfessor.id, kitName, items });
                    showSuccessModal('Seu kit foi salvo com sucesso!');
                }
                
                // Monitor: Contagem de gravação
                countWrite(1);

                resetKitForm();
                renderKits();
                
            } catch (err) {
                console.error("Erro ao salvar kit:", err);
                alert("Erro ao salvar o kit.");
            }
        });

        document.getElementById('kits-list').addEventListener('click', (e) => {
            const useBtn = e.target.closest('.use-kit-btn');
            const deleteBtn = e.target.closest('.delete-kit-btn');
            const editBtn = e.target.closest('.edit-kit-btn');

            if (useBtn) {
                const items = JSON.parse(useBtn.dataset.kitItems);
                const itemListContainer = document.getElementById('itens-list');
                itemListContainer.innerHTML = '';
                items.forEach(item => createItemRow('itens-list', item));
                createItemRow('itens-list'); 
                document.querySelector('.tab-button[data-tab="solicitacao"]').click();
            }

            if (deleteBtn) {
                const kitId = deleteBtn.dataset.id;
                showConfirmModal('Tem certeza que deseja excluir este kit?', () => {
                    deleteDoc(doc(db, 'almoxarifado', appId, 'kits', kitId)).then(() => {
                        // Monitor: Contagem de deleção
                        countDelete(1);
                        renderKits();
                        showSuccessModal('Kit excluído com sucesso.');
                        // If we were editing this kit, cancel editing
                        if (editingKitId === kitId) {
                            resetKitForm();
                        }
                    }).catch(err => console.error("Erro ao excluir kit:", err));
                });
            }
            
            if (editBtn) {
                const kitId = editBtn.dataset.id;
                const kit = localKits.find(k => k.id === kitId);
                if (kit) {
                    startEditingKit(kit);
                }
            }
        });
        
        document.getElementById('tab-content-historico').addEventListener('click', (e) => {
            const cancelBtn = e.target.closest('.cancel-solicitacao-btn');
            const reutilizarBtn = e.target.closest('.reutilizar-btn');

            if (cancelBtn) {
                const solicitacaoId = cancelBtn.dataset.id;
                const type = cancelBtn.dataset.type; 
                const collectionName = type === 'retirada' ? 'solicitacoes' : 'solicitacoes_compra';
                
                showConfirmModal('Tem certeza que deseja cancelar esta solicitação?', async () => {
                    try {
                        await updateDoc(doc(db, 'almoxarifado', appId, collectionName, solicitacaoId), {
                            status: 'Cancelado'
                        });
                        // Monitor: Contagem de gravação (update conta como write)
                        countWrite(1);

                        showSuccessModal('Sua solicitação foi cancelada.');
                    } catch (error) {
                        console.error("Erro ao cancelar solicitação:", error);
                        alert("Não foi possível cancelar a solicitação.");
                    }
                });
            }

            if (reutilizarBtn) {
                const items = JSON.parse(reutilizarBtn.dataset.solicitacaoItems);
                const periodo = reutilizarBtn.dataset.periodo;
                
                const itemListContainer = document.getElementById('itens-list');
                itemListContainer.innerHTML = '';
                items.forEach(item => createItemRow('itens-list', item));
                createItemRow('itens-list');
                
                const today = new Date().toISOString().split('T')[0];
                dataAgendamentoInput.value = today;
                
                // Set checkboxes based on the historical period (single value usually)
                if (periodo) {
                    periodosContainer.querySelectorAll('input[name="periodo"]').forEach(cb => {
                        cb.checked = (cb.value === periodo);
                    });
                    updateSelectedPeriodsText();
                }
                
                document.querySelector('.tab-button[data-tab="solicitacao"]').click();
            }
        });

        // Listeners do Modal
        closeModalBtn.addEventListener('click', closeItemModal);
        itemModal.addEventListener('click', (e) => {
            if (e.target === itemModal) closeItemModal();
        });
        itemSearchInput.addEventListener('input', filterItems);
        document.getElementById('status-update-ok-btn').addEventListener('click', () => {
            statusUpdateModal.classList.add('hidden');
        });

    </script>
</body>
</html>
