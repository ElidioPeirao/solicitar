<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitação de Material - Almoxarifado</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-section, .tabs-container { display: none; }
        .form-section.active, .tabs-container.active { display: block; }
        .matricula-feedback { transition: opacity 0.3s; }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
        /* Animações */
        .modal-enter { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Chat Styles */
        .chat-message-bubble {
            position: relative;
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.4;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .chat-bubble-me {
            background-color: #2563eb; /* blue-600 */
            color: white;
            border-bottom-right-radius: 2px;
            margin-left: auto;
        }
        .chat-bubble-other {
            background-color: #f3f4f6; /* gray-100 */
            color: #1f2937; /* gray-800 */
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 2px;
            margin-right: auto;
        }
        #prof-chat-window { transition: transform 0.3s ease-in-out, opacity 0.3s; }
        .hidden-chat { transform: translateY(20px); opacity: 0; pointer-events: none; }
        .visible-chat { transform: translateY(0); opacity: 1; pointer-events: all; }

        /* Estilo para tags de data */
        .date-tag { animation: fadeIn 0.2s ease-out; }

        /* Monitor DB */
        #db-monitor {
            font-family: 'Courier New', Courier, monospace;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            z-index: 9999;
        }
        .flash-update {
            animation: flashGreen 0.5s ease-out;
        }
        .flash-write {
            animation: flashRed 0.5s ease-out;
        }
        @keyframes flashGreen { 0% { background-color: #86efac; } 100% { background-color: black; } }
        @keyframes flashRed { 0% { background-color: #fca5a5; } 100% { background-color: black; } }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4 pb-20">

    <!-- MONITOR DE DB (Oculto) -->
    <div id="db-monitor" class="hidden fixed bottom-4 left-4 bg-black text-green-400 p-3 rounded-lg text-xs border border-green-700 opacity-90 hover:opacity-100 cursor-default select-none">
        <div class="font-bold border-b border-green-800 mb-1 pb-1 flex justify-between items-center gap-4">
            <span><i class="fas fa-database mr-1"></i>Firebase Monitor</span>
            <button id="reset-monitor" class="text-gray-500 hover:text-white" title="Zerar contadores"><i class="fas fa-sync-alt"></i></button>
        </div>
        <div class="grid grid-cols-2 gap-x-4 gap-y-1">
            <span>Leituras:</span>
            <span id="mon-reads" class="text-right font-bold text-white">0</span>
            
            <span>Escritas:</span>
            <span id="mon-writes" class="text-right font-bold text-yellow-400">0</span>
        </div>
        <div class="mt-1 text-[10px] text-gray-500 italic text-center" id="mon-status">Aguardando...</div>
    </div>

    <div class="container mx-auto max-w-4xl w-full mb-16">
        <!-- Main Container -->
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-lg">
            <h1 class="text-2xl md:text-3xl font-bold mb-6 text-gray-700 text-center">
                <i class="fas fa-paper-plane text-blue-500 mr-3"></i>Portal de Solicitação
            </h1>

            <!-- User Identification Section -->
            <div id="identification-section">
                <label for="solicitante-matricula" class="block text-sm font-medium text-gray-700 mb-1">Digite sua Matrícula para Começar</label>
                <div class="flex items-center gap-2">
                    <div class="relative flex-grow">
                        <input type="text" id="solicitante-matricula" class="w-full p-3 border border-gray-300 rounded-md shadow-sm" placeholder="Sua matrícula aqui..." required>
                        <span id="matricula-feedback-icon" class="matricula-feedback absolute right-3 top-1/2 -translate-y-1/2 text-lg opacity-0"></span>
                    </div>
                    <button type="button" id="acessar-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg">Acessar</button>
                    <button type="button" id="trocar-usuario-btn" class="hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-5 rounded-lg">Sair</button>
                </div>
                <div id="professor-info" class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-md hidden">
                    <span class="font-medium text-blue-800">Olá, </span>
                    <span id="professor-name-display" class="font-bold text-blue-900"></span>
                </div>
                <p id="matricula-error" class="text-red-600 text-sm font-semibold mt-1 hidden">Matrícula não encontrada.</p>
            </div>

            <!-- Tabs Navigation -->
            <div class="tabs-container mt-8 relative">
                <div class="border-b border-gray-200 clear-both">
                    <nav class="flex -mb-px" aria-label="Tabs">
                        <button data-tab="solicitacao" class="tab-button active w-1/4 text-center py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600">
                           <i class="fas fa-edit mr-2"></i>Solicitar
                        </button>
                        <button data-tab="kits" class="tab-button w-1/4 text-center py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600">
                           <i class="fas fa-box-archive mr-2"></i>Kits
                        </button>
                        <button data-tab="historico" class="tab-button w-1/4 text-center py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600">
                           <i class="fas fa-history mr-2"></i>Histórico
                        </button>
                        <button data-tab="compra" class="tab-button w-1/4 text-center py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600">
                           <i class="fas fa-shopping-cart mr-2"></i>Compras
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Tab Content: Solicitação -->
            <div id="tab-content-solicitacao" class="form-section">
                <form id="form-solicitacao" class="mt-6" novalidate>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                         <div class="flex flex-col">
                            <label for="data-agendamento" class="block text-sm font-medium text-gray-700 mb-1">Data da Retirada</label>
                            <div class="flex gap-2">
                                <input type="date" id="data-agendamento" class="w-full p-3 border border-gray-300 rounded-md shadow-sm" required>
                                <button type="button" id="add-date-btn" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 rounded-md font-bold transition-colors" title="Adicionar Data">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div id="selected-dates-container" class="flex flex-wrap gap-2 mt-2 min-h-[1.5rem]"></div>
                        </div>
                        
                        <!-- Coluna Períodos -->
                        <div class="relative">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Períodos de Uso</label>
                            <button type="button" id="periodo-dropdown-btn" class="w-full p-3 border border-gray-300 rounded-md shadow-sm bg-white text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <span id="periodo-selected-text" class="truncate text-gray-700">Manhã</span>
                                <i class="fas fa-chevron-down text-gray-400 text-sm ml-2"></i>
                            </button>
                            
                            <div id="periodo-dropdown-content" class="hidden absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-xl py-1">
                                <div id="periodos-container" class="flex flex-col">
                                    <label class="flex items-center px-4 py-2 hover:bg-gray-50 cursor-pointer">
                                        <input type="checkbox" name="periodo" value="Manhã" class="form-checkbox h-4 w-4 text-blue-600 rounded focus:ring-blue-500" checked>
                                        <span class="ml-3 text-sm text-gray-700">Manhã</span>
                                    </label>
                                    <label class="flex items-center px-4 py-2 hover:bg-gray-50 cursor-pointer">
                                        <input type="checkbox" name="periodo" value="Tarde" class="form-checkbox h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                                        <span class="ml-3 text-sm text-gray-700">Tarde</span>
                                    </label>
                                    <label class="flex items-center px-4 py-2 hover:bg-gray-50 cursor-pointer">
                                        <input type="checkbox" name="periodo" value="Noite" class="form-checkbox h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                                        <span class="ml-3 text-sm text-gray-700">Noite</span>
                                    </label>
                                    <div class="border-t border-gray-100 my-1"></div>
                                    <label class="flex items-center px-4 py-2 hover:bg-blue-50 cursor-pointer">
                                        <input type="checkbox" name="periodo" value="Integral" class="form-checkbox h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                                        <span class="ml-3 text-sm font-bold text-blue-800">Integral (Dia Todo)</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="md:col-span-1 flex flex-col">
                            <label for="observacao" class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                            <div id="system-obs-readonly" class="bg-gray-100 text-gray-600 p-2 border border-gray-300 border-b-0 rounded-t-md text-xs font-mono whitespace-pre-wrap"></div>
                            <textarea id="observacao" rows="2" class="w-full p-3 border border-gray-300 rounded-b-md rounded-t-none shadow-sm resize-none" placeholder="Detalhes opcionais..."></textarea>
                        </div>
                    </div>
                    
                    <h3 class="font-semibold text-lg mb-3 text-gray-700 mt-8">Itens Desejados</h3>
                    <div id="itens-list" class="space-y-4"></div>
                    <div class="mt-8 text-center">
                        <button type="submit" id="submit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg w-full md:w-auto">
                            <i class="fas fa-calendar-check mr-2"></i>Enviar Solicitação
                        </button>
                    </div>
                </form>
            </div>

            <!-- Tab Content: Kits -->
            <div id="tab-content-kits" class="form-section">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-6">
                    <div>
                        <h3 class="font-semibold text-lg mb-3 text-gray-700">Kits Salvos</h3>
                        <div id="kits-list" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
                        <p id="kits-placeholder" class="text-center py-4 text-gray-500">Nenhum kit salvo.</p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg mb-3 text-gray-700" id="create-kit-title">Criar Novo Kit</h3>
                        <form id="create-kit-form" class="bg-gray-50 p-4 rounded-lg" novalidate>
                             <div class="mb-4">
                                <label for="kit-name" class="block text-sm font-medium text-gray-700 mb-1">Nome do Kit</label>
                                <input type="text" id="kit-name" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: Kit Aula de Artes" required>
                             </div>
                             <label class="block text-sm font-medium text-gray-700 mb-1">Itens do Kit</label>
                             <div id="kit-itens-list" class="space-y-3"></div>
                             
                             <div class="flex gap-2 mt-6">
                                <button type="button" id="cancel-edit-kit-btn" class="hidden w-1/3 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 rounded-lg">Cancelar</button>
                                <button type="submit" id="submit-kit-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg">Salvar Kit</button>
                             </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Histórico -->
            <div id="tab-content-historico" class="form-section">
                <div class="bg-white pt-6 rounded-lg">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Histórico de Solicitações</h2>
                    <div id="history-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
                    <p id="history-placeholder" class="text-center py-8 text-gray-500">Nenhuma solicitação encontrada.</p>
                </div>
            </div>

            <!-- Tab Content: Solicitar Compra -->
            <div id="tab-content-compra" class="form-section">
                <div class="flex flex-col items-center justify-center bg-white pt-10 pb-10 rounded-lg min-h-[300px]">
                    <div class="bg-blue-50 p-6 rounded-full mb-6">
                        <i class="fas fa-hammer text-6xl text-blue-400"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-700 mb-2">Em Desenvolvimento</h2>
                    <p class="text-gray-500 text-center max-w-md px-4">O módulo de solicitação de compras externas está em manutenção.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== CHAT FLUTUANTE ===== -->
    
    <!-- Botão Flutuante (FAB) -->
    <button id="prof-chat-trigger" class="hidden fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-2xl z-40 transition-transform transform hover:scale-110">
        <i class="fas fa-comment-dots text-2xl"></i>
        <!-- Badge de mensagens não lidas -->
        <span id="prof-chat-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center border-2 border-white">0</span>
    </button>

    <!-- Janela de Chat -->
    <div id="prof-chat-window" class="hidden-chat fixed bottom-24 right-4 sm:right-6 w-[90%] sm:w-[350px] bg-white rounded-xl shadow-2xl z-40 flex flex-col overflow-hidden border border-gray-200 h-[500px] max-h-[70vh]">
        <!-- Chat Header -->
        <div class="bg-blue-600 p-4 text-white flex justify-between items-center shadow-md">
            <div class="flex items-center gap-3">
                <div class="bg-white/20 p-2 rounded-full"><i class="fas fa-headset"></i></div>
                <div>
                    <h3 class="font-bold text-sm">Almoxarifado</h3>
                    <p class="text-[10px] text-blue-100 flex items-center gap-1">
                        <span class="w-1.5 h-1.5 bg-green-400 rounded-full inline-block"></span> Online
                    </p>
                </div>
            </div>
            <button id="close-prof-chat" class="text-white hover:bg-white/10 p-1 rounded-full transition"><i class="fas fa-times"></i></button>
        </div>
        
        <!-- Área de Mensagens -->
        <div id="prof-chat-messages" class="flex-grow p-4 overflow-y-auto bg-gray-50 space-y-3">
            <div class="flex justify-center text-xs text-gray-400 my-4">
                <span>Início da conversa</span>
            </div>
            <!-- Mensagem de boas-vindas padrão -->
            <div class="flex w-full justify-start">
                <div class="chat-message-bubble chat-bubble-other">
                    <p>Olá! Em que podemos ajudar com sua solicitação hoje?</p>
                    <span class="text-[9px] text-gray-400 block text-right mt-1">Agora</span>
                </div>
            </div>
        </div>

        <!-- Input de Mensagem -->
        <div class="p-3 bg-white border-t">
            <form id="prof-chat-form" class="flex gap-2">
                <input type="text" id="prof-chat-input" class="flex-grow p-3 bg-gray-100 border-none rounded-full px-4 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200 transition-all" placeholder="Digite uma mensagem..." autocomplete="off">
                <button type="submit" class="bg-blue-600 text-white rounded-full w-10 h-10 flex items-center justify-center hover:bg-blue-700 shadow-md transition-colors">
                    <i class="fas fa-paper-plane text-xs"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- Modals -->
    <div id="status-update-modal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center p-4 z-50 hidden modal-enter">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md text-center">
            <div id="status-update-icon-container" class="mx-auto flex items-center justify-center h-16 w-16 rounded-full mb-5"></div>
            <h3 class="text-2xl font-bold text-gray-800">Atualização</h3>
            <p id="status-update-message" class="my-4 text-gray-600"></p>
            <button id="status-update-ok-btn" class="w-full text-white font-bold py-3 px-6 rounded-lg">OK</button>
        </div>
    </div>

    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center p-4 z-50 hidden modal-enter">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md text-center">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-5">
                <i class="fas fa-check text-4xl text-green-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800">Sucesso!</h3>
            <p id="success-message" class="my-4 text-gray-600"></p>
            <button id="success-ok-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg">OK</button>
        </div>
    </div>

    <div id="item-selection-modal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center p-4 z-50 hidden modal-enter">
        <div class="bg-gray-50 rounded-lg shadow-2xl p-6 w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-bold text-gray-800">Selecione um Item</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-red-600 text-2xl">&times;</button>
            </div>
            <div class="relative mb-4">
                <input type="text" id="item-search-input" placeholder="Buscar item..." class="w-full p-2 pl-10 border border-gray-300 rounded-md">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
            <div id="modal-items-container" class="space-y-2 overflow-y-auto pr-2"></div>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center p-4 z-50 hidden modal-enter">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md text-center">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-yellow-100 mb-5">
                <i class="fas fa-exclamation-triangle text-4xl text-yellow-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800">Confirmar</h3>
            <p id="confirm-message" class="my-4 text-gray-600"></p>
            <div class="flex justify-center gap-4 mt-6">
                <button id="confirm-cancel-btn" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                <button id="confirm-ok-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc as _addDoc, 
            getDocs as _getDocs, 
            deleteDoc as _deleteDoc, 
            doc, 
            query, 
            where, 
            serverTimestamp, 
            onSnapshot as _onSnapshot, 
            updateDoc as _updateDoc, 
            setDoc as _setDoc, 
            orderBy, 
            increment,
            limit
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCiSA3hcGqJ4BKtkxNrS9DBrEP4NcpxAVo",
            authDomain: "almoxeprojects.firebaseapp.com",
            projectId: "almoxeprojects",
            storageBucket: "almoxeprojects.appspot.com",
            messagingSenderId: "933670924253",
            appId: "1:933670924253:web:64f137671adeab3f201034",
            measurementId: "G-WDEKYB0Y20"
        };
        const appId = 'almoxarifado-app-global';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const getCollectionRef = (name) => collection(db, 'almoxarifado', appId, name);

        // --- SISTEMA DE MONITORAMENTO DE DB ---
        const dbMonitor = {
            reads: 0,
            writes: 0,
            readsEl: document.getElementById('mon-reads'),
            writesEl: document.getElementById('mon-writes'),
            statusEl: document.getElementById('mon-status'),
            boxEl: document.getElementById('db-monitor'),
            
            updateUI: function() {
                this.readsEl.innerText = this.reads;
                this.writesEl.innerText = this.writes;
            },
            
            logRead: function(count = 1) {
                this.reads += count;
                this.updateUI();
                this.flash(this.boxEl, 'flash-update');
                this.statusEl.innerText = `Lido: +${count} docs`;
                setTimeout(() => this.statusEl.innerText = 'Aguardando...', 2000);
            },
            
            logWrite: function(count = 1) {
                this.writes += count;
                this.updateUI();
                this.flash(this.boxEl, 'flash-write');
                this.statusEl.innerText = `Escrito: +${count} ops`;
                setTimeout(() => this.statusEl.innerText = 'Aguardando...', 2000);
            },

            flash: function(el, className) {
                el.classList.remove(className);
                void el.offsetWidth; // trigger reflow
                el.classList.add(className);
            },
            
            reset: function() {
                this.reads = 0;
                this.writes = 0;
                this.updateUI();
                this.statusEl.innerText = 'Resetado';
            }
        };

        document.getElementById('reset-monitor').addEventListener('click', () => dbMonitor.reset());

        // --- WRAPPERS DO FIREBASE (INTERCEPTADORES) ---
        
        async function getDocs(q) {
            const snap = await _getDocs(q);
            dbMonitor.logRead(snap.size); // Conta documentos retornados
            return snap;
        }

        async function addDoc(ref, data) {
            const res = await _addDoc(ref, data);
            dbMonitor.logWrite(1); // 1 Escrita
            return res;
        }

        async function setDoc(ref, data, options) {
            const res = await _setDoc(ref, data, options);
            dbMonitor.logWrite(1); // 1 Escrita
            return res;
        }

        async function updateDoc(ref, data) {
            const res = await _updateDoc(ref, data);
            dbMonitor.logWrite(1); // 1 Escrita (Atualização)
            return res;
        }

        async function deleteDoc(ref) {
            const res = await _deleteDoc(ref);
            dbMonitor.logWrite(1); // 1 Escrita (Deleção conta como escrita)
            return res;
        }

        function onSnapshot(refOrQuery, callback) {
            return _onSnapshot(refOrQuery, (snap) => {
                // Verificar se é uma lista (tem docChanges) ou um documento único
                if (typeof snap.docChanges === 'function') {
                    const changes = snap.docChanges().length;
                    if (changes > 0) dbMonitor.logRead(changes);
                } else {
                    dbMonitor.logRead(1);
                }
                callback(snap);
            });
        }

        // --- REMOVIDO SISTEMA DE CACHE DE DISCO ---
        // Agora usamos apenas variáveis em memória RAM para a sessão atual

        // --- Estado Global ---
        let localItems = []; 
        let globalPendingSolicitacoes = []; 
        let myPersonalSolicitacoes = []; 
        let localSolicitacoesCompra = [];
        let categoriesCache = null; // Memória RAM apenas
        let currentProfessor = null;
        let activeItemRow = null;
        let selectedDates = []; 
        let editingKitId = null;
        let localKits = [];

        // --- Listeners do Firebase (para detach) ---
        let unsubscribeItems, unsubscribePending, unsubscribeMyHistory, unsubscribeSolicitacoesCompra;
        let unsubscribeProfMessages, unsubscribeProfMeta; // Chat Listeners

        // --- Elementos DOM ---
        const matriculaInput = document.getElementById('solicitante-matricula');
        const form = document.getElementById('form-solicitacao');
        const tabsContainer = document.querySelector('.tabs-container');
        const professorInfoDiv = document.getElementById('professor-info');
        const professorNameDisplay = document.getElementById('professor-name-display');
        const matriculaError = document.getElementById('matricula-error');
        const acessarBtn = document.getElementById('acessar-btn');
        const trocarUsuarioBtn = document.getElementById('trocar-usuario-btn');
        const dataAgendamentoInput = document.getElementById('data-agendamento');
        const addDateBtn = document.getElementById('add-date-btn');
        const selectedDatesContainer = document.getElementById('selected-dates-container');
        const systemObsReadonly = document.getElementById('system-obs-readonly');
        
        // Chat DOM
        const chatTrigger = document.getElementById('prof-chat-trigger');
        const chatWindow = document.getElementById('prof-chat-window');
        const closeChatBtn = document.getElementById('close-prof-chat');
        const chatBadge = document.getElementById('prof-chat-badge');
        const chatMessagesArea = document.getElementById('prof-chat-messages');
        const chatForm = document.getElementById('prof-chat-form');
        const chatInput = document.getElementById('prof-chat-input');

        // Dropdown
        const periodoDropdownBtn = document.getElementById('periodo-dropdown-btn');
        const periodoDropdownContent = document.getElementById('periodo-dropdown-content');
        const periodoSelectedText = document.getElementById('periodo-selected-text');
        const periodosContainer = document.getElementById('periodos-container');

        // --- GERENCIAMENTO DE DADOS (SEM CACHE) ---

        async function loadItemsFromDB() {
            // Atualiza status no monitor
            const statusEl = document.getElementById('mon-status');
            if(statusEl) statusEl.innerText = "Baixando Itens...";
            
            try {
                // Sempre busca do banco
                const snap = await getDocs(getCollectionRef('itens'));
                localItems = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                revalidateAllRows();
                if(statusEl) statusEl.innerText = "Itens Atualizados";
            } catch (e) {
                console.error("Erro ao baixar itens", e);
                if(statusEl) statusEl.innerText = "Erro ao baixar";
            }
        }

        async function loadCategoriesFromDB() {
            // Verifica memória RAM primeiro (apenas para evitar refetch ao abrir/fechar modal na mesma sessão)
            if (categoriesCache) return;

            // Baixa do DB
            try {
                const snap = await getDocs(getCollectionRef('categories'));
                const catsArray = snap.docs.map(d => [d.id, d.data().name]);
                categoriesCache = new Map(catsArray);
            } catch (e) { console.error(e); }
        }

        // --- FUNÇÕES DE INICIALIZAÇÃO ---

        async function initProfessorChat(professor) {
            const chatId = `chat_${professor.id}`; 
            const chatRef = doc(getCollectionRef('chats'), chatId);
            
            // Exibir o botão flutuante
            chatTrigger.classList.remove('hidden');

            // 1. Criar/Atualizar documento do chat
            try {
                await setDoc(chatRef, {
                    professorId: professor.id,
                    professorName: professor.name,
                    lastUpdated: serverTimestamp()
                }, { merge: true });
            } catch (e) {
                console.error("Chat init error", e);
            }

            // 2. Escutar Badge (não lidas)
            unsubscribeProfMeta = onSnapshot(chatRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const unread = data.unreadProfessor || 0;
                    
                    if (unread > 0) {
                        chatBadge.textContent = unread;
                        chatBadge.classList.remove('hidden');
                        // Animar se fechado
                        if (!chatWindow.classList.contains('visible-chat')) {
                            chatTrigger.classList.add('animate-bounce');
                            setTimeout(() => chatTrigger.classList.remove('animate-bounce'), 2000);
                        }
                    } else {
                        chatBadge.classList.add('hidden');
                    }
                }
            });

            // 3. Escutar Mensagens (LIMITADO A 10 PARA REDUZIR LEITURAS)
            const messagesRef = collection(chatRef, 'messages');
            const qMessages = query(messagesRef, orderBy('timestamp', 'asc'), limit(10));
            
            unsubscribeProfMessages = onSnapshot(qMessages, (snapshot) => {
                // Limpa área (mantém msg padrão se quiser, aqui vamos reconstruir)
                chatMessagesArea.innerHTML = '';
                
                // Mensagem de sistema fixa no topo
                const welcomeDiv = document.createElement('div');
                welcomeDiv.className = 'flex w-full justify-start';
                welcomeDiv.innerHTML = `<div class="chat-message-bubble chat-bubble-other"><p>Olá ${professor.name.split(' ')[0]}! Em que podemos ajudar?</p></div>`;
                chatMessagesArea.appendChild(welcomeDiv);

                snapshot.docs.forEach(doc => {
                    const msg = doc.data();
                    const isMe = msg.senderRole === 'professor';
                    
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `flex w-full ${isMe ? 'justify-end' : 'justify-start'}`;
                    
                    const timeString = msg.timestamp ? msg.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...';

                    msgDiv.innerHTML = `
                        <div class="chat-message-bubble ${isMe ? 'chat-bubble-me' : 'chat-bubble-other'}">
                            <p>${msg.text}</p>
                            <span class="text-[9px] ${isMe ? 'text-blue-100' : 'text-gray-400'} block text-right mt-1">${timeString}</span>
                        </div>
                    `;
                    chatMessagesArea.appendChild(msgDiv);
                });
                
                // Auto scroll
                chatMessagesArea.scrollTop = chatMessagesArea.scrollHeight;
            });
        }

        // --- LÓGICA DE LOGIN ---

        acessarBtn.addEventListener('click', async () => {
            const matricula = matriculaInput.value.trim();
            if (!matricula) return;

            acessarBtn.disabled = true;
            acessarBtn.textContent = '...';

            const q = query(getCollectionRef('professores'), where("matricula", "==", matricula));
            
            try {
                // Aqui chamamos nosso getDocs monitorado
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    const docSnap = querySnapshot.docs[0];
                    const professor = { id: docSnap.id, ...docSnap.data() };
                    
                    currentProfessor = professor;
                    
                    // UI Updates
                    professorNameDisplay.textContent = professor.name;
                    professorInfoDiv.classList.remove('hidden');
                    tabsContainer.classList.add('active');
                    document.getElementById('tab-content-solicitacao').classList.add('active');
                    acessarBtn.classList.add('hidden');
                    trocarUsuarioBtn.classList.remove('hidden');
                    matriculaInput.disabled = true;
                    matriculaError.classList.add('hidden');

                    // Inicia funcionalidades
                    attachRealtimeListeners();
                    renderKits();
                    // initProfessorChat(professor); // Chat desativado temporariamente

                } else {
                    matriculaError.textContent = 'Matrícula não encontrada.';
                    matriculaError.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Erro no login:", error);
                alert("Erro de conexão.");
            } finally {
                acessarBtn.disabled = false;
                acessarBtn.textContent = 'Acessar';
            }
        });

        trocarUsuarioBtn.addEventListener('click', () => {
            // Limpa listeners
            if (unsubscribeItems) unsubscribeItems(); 
            if (unsubscribePending) unsubscribePending();
            if (unsubscribeMyHistory) unsubscribeMyHistory();
            if (unsubscribeSolicitacoesCompra) unsubscribeSolicitacoesCompra();
            if (unsubscribeProfMessages) unsubscribeProfMessages();
            if (unsubscribeProfMeta) unsubscribeProfMeta();
            
            location.reload();
        });

        // --- LÓGICA DO CHAT (UI) ---

        chatTrigger.addEventListener('click', async () => {
            // Abre Janela
            chatWindow.classList.remove('hidden-chat');
            chatWindow.classList.add('visible-chat');
            chatTrigger.classList.add('hidden'); // Esconde o botão flutuante

            // Zera badge no banco
            if (currentProfessor) {
                const chatId = `chat_${currentProfessor.id}`;
                await updateDoc(doc(getCollectionRef('chats'), chatId), { unreadProfessor: 0 });
            }
            chatMessagesArea.scrollTop = chatMessagesArea.scrollHeight;
        });

        closeChatBtn.addEventListener('click', () => {
            // Fecha Janela
            chatWindow.classList.remove('visible-chat');
            chatWindow.classList.add('hidden-chat');
            // Mostra botão de volta após transição
            setTimeout(() => chatTrigger.classList.remove('hidden'), 300);
        });

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = chatInput.value.trim();
            if (!text || !currentProfessor) return;

            chatInput.value = '';
            
            const chatId = `chat_${currentProfessor.id}`;
            const chatRef = doc(getCollectionRef('chats'), chatId);
            const messagesRef = collection(chatRef, 'messages');

            try {
                // Adiciona mensagem (Monitorado)
                await addDoc(messagesRef, {
                    text,
                    senderId: currentProfessor.id,
                    senderName: currentProfessor.name,
                    senderRole: 'professor',
                    timestamp: serverTimestamp()
                });

                // Atualiza metadados do chat para o Admin ver (Monitorado)
                await updateDoc(chatRef, {
                    lastMessage: text,
                    lastMessageTime: serverTimestamp(),
                    unreadAdmin: increment(1)
                });
            } catch(err) {
                console.error("Erro envio msg", err);
            }
        });

        // --- LÓGICA DE SOLICITAÇÃO E ESTOQUE ---

        function attachRealtimeListeners() {
            loadItemsFromDB(); // Carrega itens SEMPRE do DB

            // Mantemos PENDENTES em realtime para evitar conflito de reserva (importante)
            const qPending = query(getCollectionRef('solicitacoes'), where("status", "==", "Pendente"));
            unsubscribePending = onSnapshot(qPending, (snapshot) => {
                globalPendingSolicitacoes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                revalidateAllRows();
            });

            const qMyHistory = query(getCollectionRef('solicitacoes'), where("solicitanteId", "==", currentProfessor.id));
            unsubscribeMyHistory = onSnapshot(qMyHistory, (snapshot) => {
                const newSolicitacoes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Verifica mudanças de status para notificar
                newSolicitacoes.forEach(sol => {
                    const foundOld = myPersonalSolicitacoes.find(old => old.id === sol.id);
                    if (foundOld && foundOld.status !== sol.status) {
                        if (foundOld.status === 'Pendente' && sol.status === 'Concluída') {
                            showStatusUpdateModal(`Pedido para ${new Date(sol.dataAgendamento+'T00:00:00').toLocaleDateString('pt-BR')} aceito!`, 'success');
                        } else if (foundOld.status === 'Pendente' && sol.status === 'Rejeitada') {
                            showStatusUpdateModal(`Pedido para ${new Date(sol.dataAgendamento+'T00:00:00').toLocaleDateString('pt-BR')} recusado.`, 'error');
                        }
                    }
                });
                
                myPersonalSolicitacoes = newSolicitacoes;
                displayHistory();
            });
        }

        // --- VALIDATION LOGIC ---

        function getSelectedPeriods() {
            return Array.from(periodosContainer.querySelectorAll('input[name="periodo"]:checked')).map(cb => cb.value);
        }

        function calculateStockAndHolders(item, targetDateStr, targetPeriod) {
            const currentPhysicalStock = item.quantity || 0;
            let reservationsOnDate = 0;
            const holders = new Set();
            
            for (const sol of globalPendingSolicitacoes) {
                if (sol.dataAgendamento && sol.dataAgendamento === targetDateStr) {
                    const solPeriod = sol.periodo || 'Integral'; 
                    let isConflict = false;
                    
                    if (targetPeriod === 'Integral' || solPeriod === 'Integral' || targetPeriod === solPeriod) {
                        isConflict = true;
                    }

                    if (isConflict) {
                        for (const solItem of sol.itensSolicitados) {
                            if (solItem.itemId === item.id) {
                                reservationsOnDate += solItem.quantidade;
                                if(sol.solicitanteName) holders.add(sol.solicitanteName);
                            }
                        }
                    }
                }
            }
            
            return {
                availableStock: currentPhysicalStock - reservationsOnDate,
                holders: Array.from(holders)
            };
        }

        function handleStockValidation(rowDiv) {
            const itemId = rowDiv.dataset.itemId;
            if (!itemId) return;

            const item = localItems.find(i => i.id === itemId);
            if (!item) return;
            
            const isKitCreation = rowDiv.closest('#kit-itens-list');
            const quantityInput = rowDiv.querySelector('.item-quantity-input');
            const errorP = rowDiv.querySelector('.error-message');
            const requestedQuantity = parseInt(quantityInput.value, 10);

            if (isKitCreation) {
                const physicalStock = item.quantity || 0;
                if (!isNaN(requestedQuantity) && requestedQuantity > physicalStock) {
                     errorP.textContent = `Máx físico: ${physicalStock}`;
                     errorP.classList.remove('hidden');
                     quantityInput.classList.add('border-red-500');
                } else {
                     errorP.classList.add('hidden');
                     quantityInput.classList.remove('border-red-500');
                }
                return;
            }

            // Normal Request Validation
            const targetDate = dataAgendamentoInput.value;
            const selectedPeriods = getSelectedPeriods();
            
            if (selectedPeriods.length === 0) {
                errorP.textContent = "Selecione um período.";
                errorP.classList.remove('hidden');
                return;
            }

            let hasError = false;
            let errorMsg = "Disp: ";
            let details = [];

            selectedPeriods.forEach(period => {
                const avail = calculateStockAndHolders(item, targetDate, period).availableStock;
                const shortPeriod = period.substring(0, 1);
                details.push(`${avail} (${shortPeriod})`);
                
                if (!isNaN(requestedQuantity) && requestedQuantity > avail) {
                    hasError = true;
                }
            });
            
            if (hasError) {
                errorP.textContent = errorMsg + details.join(', ');
                errorP.classList.remove('hidden');
                quantityInput.classList.add('border-red-500');
            } else {
                errorP.classList.add('hidden');
                quantityInput.classList.remove('border-red-500');
            }
        }

        function revalidateAllRows() {
            document.querySelectorAll('#itens-list .item-row').forEach(row => handleStockValidation(row));
        }

        // --- FORMULARIO LOGIC ---

        function createItemRow(containerId, itemData = null) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'item-row flex flex-col sm:flex-row items-stretch sm:items-center gap-2 p-3 bg-white rounded-lg border shadow-sm';
            
            const itemName = itemData ? itemData.itemName : 'Toque para selecionar...';
            const itemQuantity = itemData ? itemData.quantidade : '';
            if (itemData?.itemId) div.dataset.itemId = itemData.itemId;

            div.innerHTML = `
                <div class="flex-grow relative">
                    <button type="button" class="item-select-btn w-full p-3 border border-gray-300 rounded-md text-left ${itemData ? 'text-gray-800 font-medium' : 'text-gray-400 bg-gray-50'} hover:border-blue-400 transition-colors">
                        ${itemName}
                    </button>
                    <p class="error-message text-red-600 text-xs font-semibold mt-1 ml-1 hidden"></p>
                </div>
                <div class="flex items-center gap-2">
                    <input type="number" class="item-quantity-input w-24 p-3 border-gray-300 rounded-md text-center font-bold" placeholder="Qtd" min="1" value="${itemQuantity}">
                    <button type="button" class="remove-item-btn text-red-500 hover:text-red-700 text-xl p-2 transition-transform hover:scale-110" title="Remover">
                        <i class="fas fa-minus-circle"></i>
                    </button>
                </div>
            `;
            container.appendChild(div);
            
            div.querySelector('.item-quantity-input').addEventListener('input', () => handleStockValidation(div));
            div.querySelector('.item-select-btn').addEventListener('click', () => {
                activeItemRow = div;
                openItemModal();
            });

            if(itemData) handleStockValidation(div);
        }

        // --- ITEM SELECTION MODAL ---

        async function openItemModal() {
            const modalContainer = document.getElementById('modal-items-container');
            const searchInput = document.getElementById('item-search-input');
            const modal = document.getElementById('item-selection-modal');
            
            modalContainer.innerHTML = '';
            const isKitCreation = activeItemRow && activeItemRow.closest('#kit-itens-list');
            const targetDate = dataAgendamentoInput.value;
            const selectedPeriods = getSelectedPeriods();
            const targetPeriodForModal = selectedPeriods.length > 0 ? selectedPeriods : ['Manhã'];

            // Carrega categorias (via DB, sem cache persistente)
            await loadCategoriesFromDB();

            const categorizedItems = {};
            
            localItems.forEach(item => {
                let minAvail = 9999;
                let holdersSet = new Set();
                
                if (isKitCreation) {
                    minAvail = item.quantity || 0;
                } else {
                    targetPeriodForModal.forEach(p => {
                        const { availableStock, holders } = calculateStockAndHolders(item, targetDate, p);
                        if (availableStock < minAvail) minAvail = availableStock;
                        holders.forEach(h => holdersSet.add(h));
                    });
                }

                const catName = categoriesCache && categoriesCache.has(item.categoryId) ? categoriesCache.get(item.categoryId) : 'Outros';
                if (!categorizedItems[catName]) categorizedItems[catName] = [];
                categorizedItems[catName].push({ ...item, availableStock: minAvail, holders: Array.from(holdersSet) });
            });

            Object.keys(categorizedItems).sort().forEach(cat => {
                const details = document.createElement('details');
                details.className = 'category-accordion bg-white rounded-lg border mb-2';
                details.innerHTML = `
                    <summary class="flex justify-between items-center p-3 font-semibold text-gray-700 hover:bg-gray-100 cursor-pointer">
                        <span>${cat}</span><i class="fas fa-chevron-right chevron"></i>
                    </summary>
                    <div class="items-grid p-3 border-t grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
                `;
                const grid = details.querySelector('.items-grid');
                
                categorizedItems[cat].forEach(item => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    const isUnavailable = item.availableStock <= 0;
                    
                    btn.className = `item-button text-left p-2 rounded-md border transition-all ${isUnavailable ? 'bg-red-50 border-red-100 opacity-60' : 'bg-gray-50 hover:bg-blue-50 hover:border-blue-300'}`;
                    if(isUnavailable) btn.disabled = true;

                    const stockText = isKitCreation ? 'Físico' : 'Disp';
                    const holderText = !isKitCreation && item.holders.length > 0 ? `Com: ${item.holders[0]}` : '';

                    btn.innerHTML = `
                        <div class="flex justify-between w-full">
                            <span class="font-semibold text-gray-700 text-sm">${item.name}</span>
                            <span class="text-xs font-bold ${isUnavailable ? 'text-red-500' : 'text-green-600'}">${item.availableStock}</span>
                        </div>
                        <div class="flex justify-between mt-1">
                            <span class="text-[10px] text-gray-500">${stockText}</span>
                            ${isUnavailable ? `<span class="text-[10px] text-red-400 truncate max-w-[80px]">${holderText}</span>` : ''}
                        </div>
                    `;
                    if(!isUnavailable) {
                        btn.onclick = () => {
                            if(activeItemRow) {
                                const btnSelect = activeItemRow.querySelector('.item-select-btn');
                                btnSelect.textContent = item.name;
                                btnSelect.classList.remove('text-gray-400', 'bg-gray-50');
                                btnSelect.classList.add('text-gray-800', 'font-medium');
                                activeItemRow.dataset.itemId = item.id;
                                handleStockValidation(activeItemRow);
                                
                                // Auto-create next row
                                const container = activeItemRow.parentElement;
                                if (activeItemRow === container.lastElementChild) createItemRow(container.id);
                            }
                            modal.classList.add('hidden');
                        };
                    }
                    grid.appendChild(btn);
                });
                document.getElementById('modal-items-container').appendChild(details);
            });

            modal.classList.remove('hidden');
            searchInput.value = '';
            searchInput.focus();
        }

        document.getElementById('item-search-input').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('.category-accordion').forEach(acc => {
                let hasItem = false;
                acc.querySelectorAll('.item-button').forEach(btn => {
                    const name = btn.querySelector('.font-semibold').textContent.toLowerCase();
                    if(name.includes(term)) { btn.style.display = 'block'; hasItem = true; }
                    else btn.style.display = 'none';
                });
                acc.style.display = hasItem ? 'block' : 'none';
                if(term && hasItem) acc.open = true;
            });
        });

        // --- SUBMIT E GESTÃO DE DATAS ---

        addDateBtn.addEventListener('click', () => {
            const dateVal = dataAgendamentoInput.value;
            const selectedPeriods = getSelectedPeriods();
            if (!dateVal || selectedPeriods.length === 0) return alert('Selecione data e período.');
            
            let added = 0;
            selectedPeriods.forEach(p => {
                if (!selectedDates.some(d => d.date === dateVal && d.period === p)) {
                    selectedDates.push({ date: dateVal, period: p });
                    added++;
                }
            });
            
            if (added > 0) renderSelectedDates();
            else alert('Data já adicionada.');
        });

        function renderSelectedDates() {
            selectedDatesContainer.innerHTML = '';
            // Sort
            selectedDates.sort((a,b) => a.date.localeCompare(b.date) || a.period.localeCompare(b.period));
            
            selectedDates.forEach(d => {
                const dateFmt = new Date(d.date+'T00:00:00').toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
                const tag = document.createElement('div');
                tag.className = 'date-tag bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full flex items-center gap-2';
                tag.innerHTML = `<span>${dateFmt} - ${d.period}</span><button type="button" class="hover:text-red-600">&times;</button>`;
                tag.querySelector('button').onclick = () => {
                    selectedDates = selectedDates.filter(x => !(x.date === d.date && x.period === d.period));
                    renderSelectedDates();
                };
                selectedDatesContainer.appendChild(tag);
            });
            renderSystemObs();
        }

        function renderSystemObs() {
            let text = "Agendamento:\n";
            let dates = selectedDates.length > 0 ? selectedDates : [];
            
            if(dates.length === 0 && dataAgendamentoInput.value) {
                getSelectedPeriods().forEach(p => dates.push({date: dataAgendamentoInput.value, period: p}));
            }

            if(dates.length === 0) text += "(Selecione data/período)";
            else dates.forEach(d => {
                const fmt = new Date(d.date+'T00:00:00').toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
                text += `- ${fmt} (${d.period})\n`;
            });
            systemObsReadonly.innerText = text;
        }

        // Logic for Dropdown
        periodoDropdownBtn.addEventListener('click', (e) => { e.stopPropagation(); periodoDropdownContent.classList.toggle('hidden'); });
        document.addEventListener('click', (e) => { if(!periodoDropdownContent.contains(e.target) && !periodoDropdownBtn.contains(e.target)) periodoDropdownContent.classList.add('hidden'); });
        
        periodosContainer.addEventListener('change', (e) => {
            if(e.target.name === 'periodo') {
                const val = e.target.value;
                const checked = e.target.checked;
                if(val === 'Integral' && checked) periodosContainer.querySelectorAll('input:not([value="Integral"])').forEach(c => c.checked = false);
                else if(val !== 'Integral' && checked) {
                    const integ = periodosContainer.querySelector('input[value="Integral"]');
                    if(integ) integ.checked = false;
                }
                
                const sels = getSelectedPeriods();
                periodoSelectedText.textContent = sels.length === 0 ? "Selecione..." : (sels.includes('Integral') ? "Integral" : sels.join(', '));
                revalidateAllRows();
                renderSystemObs();
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processando...';

            // Datas
            let targets = selectedDates.length > 0 ? selectedDates : [];
            if(targets.length === 0) {
                const d = dataAgendamentoInput.value;
                const ps = getSelectedPeriods();
                if(d && ps.length > 0) ps.forEach(p => targets.push({date: d, period: p}));
            }

            if(targets.length === 0) {
                alert('Defina as datas.'); btn.disabled = false; btn.innerHTML = '<i class="fas fa-calendar-check mr-2"></i>Enviar'; return;
            }

            // Itens
            const items = [];
            document.querySelectorAll('#itens-list .item-row').forEach(row => {
                const id = row.dataset.itemId;
                const q = parseInt(row.querySelector('.item-quantity-input').value);
                if(id && q > 0) {
                    const item = localItems.find(i => i.id === id);
                    if(item) items.push({ itemId: id, itemName: item.name, quantidade: q, _stock: item });
                }
            });

            if(items.length === 0) {
                alert('Adicione itens.'); btn.disabled = false; btn.innerHTML = '<i class="fas fa-calendar-check mr-2"></i>Enviar'; return;
            }

            // Validar Estoque
            for(const t of targets) {
                for(const i of items) {
                    const avail = calculateStockAndHolders(i._stock, t.date, t.period).availableStock;
                    if(i.quantidade > avail) {
                        alert(`Estoque insuficiente de "${i.itemName}" para ${t.date} (${t.period}). Disp: ${avail}`);
                        btn.disabled = false; btn.innerHTML = '<i class="fas fa-calendar-check mr-2"></i>Enviar'; return;
                    }
                }
            }

            // Enviar
            const obsSys = systemObsReadonly.innerText;
            const obsUser = document.getElementById('observacao').value;
            const finalObs = obsSys + (obsUser ? '\nMsg: ' + obsUser : '');
            const finalItems = items.map(({_stock, ...rest}) => rest);

            try {
                // Monitorado (addDoc)
                const batch = targets.map(t => addDoc(getCollectionRef('solicitacoes'), {
                    solicitanteId: currentProfessor.id,
                    solicitanteName: currentProfessor.name,
                    itensSolicitados: finalItems,
                    dataAgendamento: t.date,
                    periodo: t.period,
                    observacao: finalObs,
                    status: 'Pendente',
                    timestamp: serverTimestamp()
                }));
                await Promise.all(batch);
                
                showSuccessModal('Solicitações enviadas com sucesso!');
                // Reset
                document.getElementById('observacao').value = '';
                document.getElementById('itens-list').innerHTML = '';
                createItemRow('itens-list');
                selectedDates = []; renderSelectedDates();
                
            } catch(err) {
                console.error(err);
                alert('Erro ao enviar.');
            } finally {
                btn.disabled = false; btn.innerHTML = '<i class="fas fa-calendar-check mr-2"></i>Enviar';
            }
        });

        // --- KITS E HISTÓRICO (Simples) ---
        async function renderKits() {
            const list = document.getElementById('kits-list');
            list.innerHTML = '';
            const q = query(getCollectionRef('kits'), where("professorId", "==", currentProfessor.id));
            
            // Monitorado
            const snap = await getDocs(q);
            document.getElementById('kits-placeholder').classList.toggle('hidden', !snap.empty);
            
            localKits = snap.docs.map(d => ({id: d.id, ...d.data()}));
            localKits.forEach(kit => {
                const div = document.createElement('div');
                div.className = 'p-4 border rounded-lg bg-white shadow-sm';
                div.innerHTML = `
                    <div class="flex justify-between">
                        <span class="font-bold">${kit.kitName}</span>
                        <div class="gap-2 flex">
                            <button class="edit-kit text-blue-500"><i class="fas fa-edit"></i></button>
                            <button class="del-kit text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 my-2">${kit.items.map(i => `${i.quantidade}x ${i.itemName}`).join(', ')}</div>
                    <button class="use-kit w-full bg-blue-50 text-blue-700 py-1 rounded text-sm font-semibold hover:bg-blue-100">Usar Kit</button>
                `;
                
                div.querySelector('.del-kit').onclick = async () => {
                    // Substitui confirm() por showConfirmModal
                    showConfirmModal('Tem a certeza que deseja excluir este kit?', async () => {
                        await deleteDoc(doc(db, 'almoxarifado', appId, 'kits', kit.id));
                        renderKits();
                    });
                };
                div.querySelector('.edit-kit').onclick = () => {
                    document.getElementById('kit-name').value = kit.kitName;
                    document.getElementById('kit-itens-list').innerHTML = '';
                    kit.items.forEach(i => createItemRow('kit-itens-list', i));
                    createItemRow('kit-itens-list');
                    editingKitId = kit.id;
                    document.getElementById('create-kit-title').textContent = "Editar Kit";
                    document.getElementById('submit-kit-btn').textContent = "Atualizar";
                    document.getElementById('cancel-edit-kit-btn').classList.remove('hidden');
                };
                div.querySelector('.use-kit').onclick = () => {
                    document.getElementById('itens-list').innerHTML = '';
                    kit.items.forEach(i => createItemRow('itens-list', i));
                    createItemRow('itens-list');
                    document.querySelector('[data-tab="solicitacao"]').click();
                };
                list.appendChild(div);
            });
        }

        document.getElementById('create-kit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('kit-name').value;
            const items = [];
            document.querySelectorAll('#kit-itens-list .item-row').forEach(r => {
                const id = r.dataset.itemId;
                const q = r.querySelector('input').value;
                if(id && q) items.push({itemId: id, itemName: r.querySelector('button').textContent.trim(), quantidade: parseInt(q)});
            });
            if(items.length === 0) return alert('Adicione itens.');
            
            if(editingKitId) {
                // Monitorado
                await updateDoc(doc(db, 'almoxarifado', appId, 'kits', editingKitId), { kitName: name, items });
            } else {
                // Monitorado
                await addDoc(getCollectionRef('kits'), { professorId: currentProfessor.id, kitName: name, items });
            }
            
            document.getElementById('create-kit-form').reset();
            document.getElementById('kit-itens-list').innerHTML = '';
            createItemRow('kit-itens-list');
            renderKits();
            document.getElementById('cancel-edit-kit-btn').click();
        });

        document.getElementById('cancel-edit-kit-btn').onclick = () => {
            editingKitId = null;
            document.getElementById('create-kit-form').reset();
            document.getElementById('kit-itens-list').innerHTML = '';
            createItemRow('kit-itens-list');
            document.getElementById('create-kit-title').textContent = "Criar Novo Kit";
            document.getElementById('submit-kit-btn').textContent = "Salvar Kit";
            document.getElementById('cancel-edit-kit-btn').classList.add('hidden');
        };

        function displayHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            
            // Ordenar e pegar apenas os últimos 10 (Client-side)
            const historyToShow = myPersonalSolicitacoes
                .sort((a,b) => {
                    const timeA = a.timestamp ? a.timestamp.seconds : 0;
                    const timeB = b.timestamp ? b.timestamp.seconds : 0;
                    return timeB - timeA;
                })
                .slice(0, 10);

            document.getElementById('history-placeholder').classList.toggle('hidden', historyToShow.length > 0);
            
            historyToShow.forEach(sol => {
                const div = document.createElement('div');
                div.className = 'p-4 border rounded-lg bg-gray-50';
                const statusColor = {'Pendente':'bg-yellow-100 text-yellow-800','Concluída':'bg-green-100 text-green-800','Rejeitada':'bg-red-100 text-red-800','Cancelado':'bg-gray-200'}[sol.status] || 'bg-gray-100';
                
                div.innerHTML = `
                    <div class="flex justify-between">
                        <span class="font-bold text-gray-700">${new Date(sol.dataAgendamento+'T00:00:00').toLocaleDateString('pt-BR')} (${sol.periodo})</span>
                        <span class="px-2 rounded text-xs font-bold ${statusColor} flex items-center">${sol.status}</span>
                    </div>
                    <div class="text-xs mt-2 text-gray-600">${sol.itensSolicitados.map(i => `${i.quantidade}x ${i.itemName}`).join(', ')}</div>
                    <div class="flex gap-4 mt-3 pt-2 border-t border-gray-200">
                        <button class="repeat-req text-blue-600 text-xs font-bold hover:text-blue-800 flex items-center transition-colors">
                            <i class="fas fa-redo-alt mr-1"></i> Repetir Pedido
                        </button>
                        ${sol.status === 'Pendente' ? `<button class="cancel-req text-red-500 text-xs font-bold hover:text-red-700 flex items-center transition-colors"><i class="fas fa-times mr-1"></i> Cancelar</button>` : ''}
                    </div>
                `;

                // Lógica do botão Repetir - Substituído confirm() por showConfirmModal
                div.querySelector('.repeat-req').onclick = () => {
                    showConfirmModal('Deseja carregar os itens deste pedido na área de solicitação?', () => {
                        // Limpa a lista atual
                        document.getElementById('itens-list').innerHTML = '';
                        
                        // Recria os itens do histórico
                        if (sol.itensSolicitados) {
                            sol.itensSolicitados.forEach(i => createItemRow('itens-list', i));
                        }
                        
                        // Adiciona uma linha vazia no final para novos itens
                        createItemRow('itens-list');
                        
                        // Vai para a aba de solicitação
                        document.querySelector('[data-tab="solicitacao"]').click();
                        
                        // Scroll para o topo suavemente
                        document.getElementById('identification-section').scrollIntoView({ behavior: 'smooth' });
                    });
                };

                if(sol.status === 'Pendente') {
                    div.querySelector('.cancel-req').onclick = async () => {
                        // Substitui confirm() por showConfirmModal
                        showConfirmModal('Tem a certeza que deseja cancelar esta solicitação?', async () => {
                            await updateDoc(doc(db, 'almoxarifado', appId, 'solicitacoes', sol.id), {status: 'Cancelado'});
                        });
                    };
                }
                list.appendChild(div);
            });
        }

        // --- TABS & HELPERS ---
        document.querySelectorAll('.tab-button').forEach(b => b.onclick = () => {
            document.querySelectorAll('.tab-button').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.form-section').forEach(x => x.classList.remove('active'));
            b.classList.add('active');
            document.getElementById(`tab-content-${b.dataset.tab}`).classList.add('active');
        });

        document.getElementById('close-modal-btn').onclick = () => document.getElementById('item-selection-modal').classList.add('hidden');
        document.getElementById('status-update-ok-btn').onclick = () => document.getElementById('status-update-modal').classList.add('hidden');
        document.getElementById('success-ok-btn').onclick = () => document.getElementById('success-modal').classList.add('hidden');
        document.getElementById('confirm-cancel-btn').onclick = () => document.getElementById('confirm-modal').classList.add('hidden');

        // FUNÇÃO DE CONFIRMAÇÃO SEGURA (Substitui o window.confirm nativo)
        window.showConfirmModal = (msg, onConfirmCallback) => {
            document.getElementById('confirm-message').textContent = msg;
            const modal = document.getElementById('confirm-modal');
            const okBtn = document.getElementById('confirm-ok-btn');
            
            // Remove listeners antigos clonando o botão
            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            
            newOkBtn.onclick = () => {
                onConfirmCallback();
                modal.classList.add('hidden');
            };
            
            modal.classList.remove('hidden');
        };

        // Helpers globais para modais
        window.showStatusUpdateModal = (msg, type) => {
            const icon = document.getElementById('status-update-icon-container');
            const btn = document.getElementById('status-update-ok-btn');
            document.getElementById('status-update-message').textContent = msg;
            
            if(type === 'success') {
                icon.className = 'mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-5';
                icon.innerHTML = '<i class="fas fa-check text-4xl text-green-600"></i>';
                btn.className = 'w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg';
            } else {
                icon.className = 'mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 mb-5';
                icon.innerHTML = '<i class="fas fa-times text-4xl text-red-600"></i>';
                btn.className = 'w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg';
            }
            document.getElementById('status-update-modal').classList.remove('hidden');
        };

        window.showSuccessModal = (msg) => {
            document.getElementById('success-message').textContent = msg;
            document.getElementById('success-modal').classList.remove('hidden');
        };

        // Init
        dataAgendamentoInput.value = new Date().toISOString().split('T')[0];
        dataAgendamentoInput.addEventListener('change', () => { revalidateAllRows(); renderSystemObs(); });
        
        // APENAS UMA CHAMADA PARA CADA - Corrigido duplicidade
        createItemRow('itens-list');
        createItemRow('kit-itens-list');
        
        document.getElementById('itens-list').addEventListener('click', e => { if(e.target.closest('.remove-item-btn')) e.target.closest('.item-row').remove(); });
        document.getElementById('kit-itens-list').addEventListener('click', e => { if(e.target.closest('.remove-item-btn')) e.target.closest('.item-row').remove(); });

        // Força atualização da observação inicial
        renderSystemObs();

    </script>
</body>
</html>
